---
title: "Tahoe_Peri_model_building"
output: html_document
date: "2023-05-07"
---
Building models for GPP, ER, and NEP using periphyton incubation data.

Running model validation and diagnostics.

```{r setup, include=FALSE}
library(ggplot2)
library(tidyverse)
library(lubridate)
library(ggpubr)
library(plotly)
library(reshape2)
library(DescTools)
library(arm)
library(nlme)
library(lattice)
library(emmeans)
library(sjPlot)
library(sjmisc)
library(sjlabelled)
library(patchwork)
library(gt)

# changing working directory from /scripts to /tahoe_lab_inc_analysis
knitr::opts_chunk$set(root.dir = '..')
```

# importing data
```{r}
dat_clean <- read_csv("data/main_analysis/cleaned_rate_data.csv")
```

# Models using new AFDW-normalized metab rates and only for repeated-measured experiments
# GPP
## model building
### Table E1
```{r}
# making new dataset for lme models to remove NAs and data from april 2021 experiments
dat_lme <- dat_clean %>%
  filter(!is.na(GPP_mgO2_d_gAFDW_2) & exp_ID > 4)

# converting experiment ID, nutrient_trt, and month from numeric to a factor so that they are coded as such in the model instead of as a character
dat_lme$exp_ID <- as.factor(dat_lme$exp_ID)
dat_lme$nutrient_trt <- as.factor(dat_lme$nutrient_trt)
dat_lme$month <- as.factor(dat_lme$month)

# reordering month variable so it graphs months in order
dat_lme$month <- factor(dat_lme$month, levels = c("february", "june", "august", "october", "november"))


levels(dat_lme$month)


# reordering nutrient trt variable so that enriched is first; this guarantees that the nutrient trt effect reported in the model summary reflects the effect of the enriched treatment rather than the ambient treatment
dat_lme$nutrient_trt <- factor(dat_lme$nutrient_trt, levels = c("ambient", "enriched"))


levels(dat_lme$nutrient_trt)
#glimpse(dat_lme)
#View(dat_lme)

###### intercept- only model
m0 <- gls(log(GPP_mgO2_d_gAFDW_2) ~ 1, data = dat_lme)

###### Model 1: Generalized least squares model starting with as many explanatory variables as possible in the fixed effects component of the models (temp, nutrients, their interaction, and month)
m1 <- gls(log(GPP_mgO2_d_gAFDW_2) ~ temp_C * nutrient_trt * month, method = "REML", data = dat_lme)


# can add this to lme model code in any model to get model summaries in sum contrast form:
# contrasts = list(month = contr.sum, nutrient_trt = contr.sum)

###### Model 2: adding a random effect for individual rocks (our sampling unit)
m2 <- lme(log(GPP_mgO2_d_gAFDW_2) ~ temp_C * nutrient_trt * month, random = ~ 1 | rock_ID, data = dat_lme) # adding in random intercept for each rock sample

###### Model 3: adding weights to the variance of each exp_ID to account for non-homogenous variance between experiments
m3 <- lme(log(GPP_mgO2_d_gAFDW_2) ~ temp_C * nutrient_trt * month, random = ~ 1 | rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme) # incorporating weights to account for heteroscedasticity within and btwn different experiments

###### Model 3: adding weights to the variance of each exp_ID to account for non-homogenous variance between experiments
#m4 <- lme(log(GPP_mgO2_d_gAFDW_2) ~ temp_C * nutrient_trt * month, random = ~ 1 + temp_C | rock_ID, data = dat_lme, control=(msMaxIter=1000), contrasts = list(month = contr.sum, nutrient_trt = contr.sum)) # adding in random intercept and slope for each rock sample, also increasing the number of iterations to acheive model convergence
# does not converge


m5 <- lme(log(GPP_mgO2_d_gAFDW_2) ~ temp_C * nutrient_trt * month, random = ~ 1 + temp_C | rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme, control=(msMaxIter=1000)) # incorporating weights to account for heteroscedasticity within and btwn different experiments, also increasing the number of iterations to acheive model convergence
# including month as a fixed effect (interested in interpreting seasonal effects and interactions with temp and nutrient effects)
# coded in nutrient_trt as a factor instead of nutrients which is of class numeric
# used contrasts for month and nutrient_trt so that the coefficients were interpretable as the average of that effect over all the other variable combinations instead of in relation to the first default factor setting (ambient nutrients or the first month in the data set). This change got rid of covariance structure between temp_C and month in the model and made interpretations of the coefficients more intuitive.

summary(m5)

model.matrix(log(GPP_mgO2_d_gAFDW_2) ~ temp_C * nutrient_trt * month, dat_lme, contrasts.arg = list(month = contr.sum, nutrient_trt = contr.sum))

# comparing AICs of models
AIC(m0, m1, m2, m3, m5)



# if you want model results to be presented using sum contrasts then use this code
GPP_contr_sum <- update(m5, contrasts = list(month = contr.sum, nutrient_trt = contr.sum)) # updating contrast matrix of the final model summary
summary(GPP_contr_sum)




GPP_final <- m5

# makng a comparison of model summaries for m5 with and without contrast sums
tab_model(GPP_contr_sum, dv.labels = "Sum Contrasts",
  show.ci = FALSE,
  show.aic = T,
  p.style = "stars",
  transform = "exp",
  file = "plots/main_analysis/GPP_mod_sum_contrasts.doc")

tab_model(GPP_final, dv.labels = "Regular",
  show.ci = FALSE,
  show.aic = T,
  p.style = "stars",
  transform = "exp",
  file = "plots/main_analysis/GPP_mod_regular.doc")



summary(GPP_final)

# saving model results
saveRDS(GPP_final, "models/GPP_final_mod.rds")

# reading in model
GPP_final <- readRDS("models/GPP_final_mod.rds")

tab_model(m0, m1, m2, m3, m5, dv.labels = c("Intercept only", "GLS", "LMM1", "LMM2", "LMM3"),
  show.ci = FALSE,
  show.aic = T,
  p.style = "stars",
  transform = "exp",
  file = "plots/final_paper/TableE1.doc")
# reference levels for interpreting intercept term: nutrient_trt = ambient, month = february



# trying remove intercept from final GPP model using update()
# this will make fixed effects output of model easier to interpret in the manuscript
GPP_new <- update(GPP_final, ~ . - 1)

# comparing coefficient estimates of the fixed effects to make sure that they're the same
View(summary(GPP_new))
View(summary(GPP_final))
```

## model diagnostics
```{r}
# plot of standardized residuals
plot(GPP_final)

# plot of standardized residuals by month
plot(GPP_final, resid(.,type="p") ~ fitted(.) | month, abline=0)

# plot of standardized residuals by temperature trt
plot(GPP_final, resid(.,type="p") ~ fitted(.) | temp_C, abline=0)

# plot of standardized residuals by nutrient trt
plot(GPP_final, resid(.,type="p") ~ fitted(.) | nutrient_trt, abline=0)

# qq plot to assess normality of residuals
qqnorm(GPP_final)
```

## estimated marginal means
```{r}
# nutrient effect averaged over season
emmeans(GPP_final, pairwise ~ nutrient_trt, cov.keep = "temp_C", type = "response")

# nutrient effect by season
nut_seasonal <- emmeans(GPP_final, pairwise ~ nutrient_trt|month, cov.keep = "temp_C", type = "response")

# saving emmeans contrasts as a dataframe so I can export results in a table
nut_seasonal <- nut_seasonal$contrasts %>%
  as.data.frame() %>% 
  mutate(across(c(ratio:p.value), ~signif(.,4))) # rounding numbers in all numeric columns to 4 sig figs

#######################################

# effect of month on GPP averaged across all levels of temperature and nutrients, with direct pairwise comparisions between months.
emmeans(GPP_final, pairwise ~ month, cov.keep = "temp_C", type = "response")

############################
# interaction between month and temperature, with the difference slopes of temperature effects on GPP given for each month
temp_seasonal <- emtrends(GPP_final, pairwise ~ month, var = "temp_C")

# saving emtrends contrasts as a dataframe so I can export results in a table
temp_seasonal <- temp_seasonal$contrasts %>%
  as.data.frame()

# printing table of data
temp_table <- temp_seasonal %>%
    gt() %>%
  tab_header(title = "Seasonal Variation in Temperature Effects on Periphyton GPP")
gtsave("plots/main_analysis/temp_seasonal_GPP.png", data = temp_table)


# now making a table of the emmeans instead of the contrasts for the same emtrends results

temp_seasonal_emm <- emtrends(GPP_final, pairwise ~ month, var = "temp_C")

temp_seasonal_emm <- temp_seasonal_emm$emtrends %>%
  as.data.frame() # saving emtrends contrasts as a dataframe so I can export results in a table
  

# printing table of data and calculating Q10 values from temperature coefficients (done by raising them to the 10th power)
temp_emmeans_table <- temp_seasonal_emm %>%
  mutate(temp_C.trend = exp(temp_C.trend)) %>% # putting the estimated temp trends in the response scale by undoing the log-transformation
  mutate(Q10_value = temp_C.trend^10) %>% # calculating Q10 values
  mutate(across(c(temp_C.trend:Q10_value), ~round(.,4))) %>% # rounding all numeric columns to 4 sig figs
    gt() %>%
  cols_move(columns = Q10_value, after = temp_C.trend) %>%
  cols_label(temp_C.trend = "temperature effect", Q10_value = html("Q<sub>10</sub> ")) %>%
  tab_header(title = "Seasonal Variation in Temperature Effects on Periphyton GPP")
gtsave("plots/main_analysis/temp_seasonal_GPP_emmeans.png", data = temp_emmeans_table)


############################
# interaction between temperature and nutrients by month
temp_nut_seasonal <- emtrends(GPP_final, pairwise ~ nutrient_trt | month, var = "temp_C")

#######################
# interaction plot of temp, nutrients, and month in log scale
GPP_IP <- emmip(GPP_final, nutrient_trt ~ temp_C|month, CIs = FALSE, cov.keep = c("temp_C", "nutrient_trt")) +
  geom_point(aes(x = temp_C, y = log(GPP_mgO2_d_gAFDW_2), color = nutrient_trt), data = dat_lme, inherit.aes = FALSE) +
  facet_grid(cols = vars(month)) +
  labs(y = expression(log(GPP~(mgO[2]~day^{-1}~gAFDW^{-1}))), x = "") +
  scale_color_manual(values = c("#00BFC4", "#F8766D")) +
  theme_bw() +
  theme(legend.position = "none")

```

# ER
## model building
### Table E2
```{r}
# making new dataset for lme models to remove NAs and data from april 2021 experiments
dat_lme <- dat_clean %>%
  filter(!is.na(ER_mgO2_d_gAFDW_2) & exp_ID > 4)

# converting experiment ID, nutrient_trt, and month from numeric to a factor so that they are coded as such in the model instead of as a character
dat_lme$exp_ID <- as.factor(dat_lme$exp_ID)
dat_lme$nutrient_trt <- as.factor(dat_lme$nutrient_trt)
dat_lme$month <- as.factor(dat_lme$month)

# reordering month variable so it graphs months in order
dat_lme$month <- factor(dat_lme$month, levels = c("february", "june", "august", "october", "november"))


levels(dat_lme$month)

# reordering nutrient trt variable so that enriched is first; this guarantees that the nutrient trt effect reported in the model summary reflects the effect of the enriched treatment rather than the ambient treatment
dat_lme$nutrient_trt <- factor(dat_lme$nutrient_trt, levels = c("ambient", "enriched"))


levels(dat_lme$nutrient_trt)

#glimpse(dat_lme)
#View(dat_lme)

# intercept- only model
m0 <- gls(log(ER_mgO2_d_gAFDW_2) ~ 1, data = dat_lme)

# starting with as many explanatory variables as possible in the fixed effects component of the models (temp, nutrients, their interaction, and autotrophic index (AI))

m1 <- gls(log(ER_mgO2_d_gAFDW_2) ~ temp_C * nutrient_trt * month, method = "REML", data = dat_lme)


# can put this in any of the lme model code below to get the model summary in sum contrast form:
# contrasts = list(month = contr.sum, nutrient_trt = contr.sum)


m2 <- lme(log(ER_mgO2_d_gAFDW_2) ~ temp_C * nutrient_trt * month, random = ~ 1 | rock_ID, data = dat_lme) # adding in random intercept for each rock sample

m3 <- lme(log(ER_mgO2_d_gAFDW_2) ~ temp_C * nutrient_trt * month, random = ~ 1 | rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme) # incorporating weights to account for heteroscedasticity within and btwn different experiments

#m4 <- lme(log(ER_mgO2_d_gAFDW_2) ~ temp_C * nutrient_trt * month, random = ~ 1 + temp_C | rock_ID, data = dat_lme, control=(msMaxIter=1000), contrasts = list(month = contr.sum, nutrient_trt = contr.sum)) # adding in random intercept and slope for each rock sample, also increasing the number of iterations to acheive model convergence
# does not converge



#m5 <- lme(log(ER_mgO2_d_gAFDW_2) ~ temp_C * nutrient_trt * month, random = ~ 1 + temp_C | rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme, control=(msMaxIter=1000), contrasts = list(month = contr.sum, nutrient_trt = contr.sum)) 
# does not converge
# incorporating weights to account for heteroscedasticity within and btwn different experiments, also increasing the number of iterations to acheive model convergence
# including month as a fixed effect (interested in interpreting seasonal effects and interactions with temp and nutrient effects)
# coded in nutrient_trt as a factor instead of nutrients which is of class numeric
# used contrasts for month and nutrient_trt so that the coefficients were interpretable as the average of that effect over all the other variable combinations instead of in relation to the first default factor setting (ambient nutrients or the first month in the data set). This change got rid of covariance structure between temp_C and month in the model and made interpretations of the coefficients more intuitive.

summary(m3)

# comparing AICs of models
AIC(m0, m1, m2, m3)

ER_final <- m3

# saving model object
saveRDS(ER_final, "models/ER_final_mod.rds")

# reading in model object
ER_final <- readRDS("models/ER_final_mod.rds")

summary(ER_final)

tab_model(m0, m1, m2, m3, dv.labels = c("Intercept only", "GLS", "LMM1", "LMM2"),
  show.ci = FALSE,
  show.aic = T,
  p.style = "stars",
  transform = "exp",
  file = "plots/final_paper/TableE2.doc")
# reference levels for interpreting intercept term: nutrient_trt = enriched, month = february




# updating ER model to add contrast sums using update()
# this will make the fixed effect estimates be relative to the grand mean which can aid in interpretation
ER_new <- update(ER_final, ~ contrasts = list(month = contr.sum, nutrient_trt = contr.sum))
summary(ER_new)
```

## model diagnostics
```{r}
plot(ER_final)

# plot of standardized residuals by month
plot(ER_final, resid(.,type="p") ~ fitted(.) | month, abline=0)

# plot of standardized residuals by temperature trt
plot(ER_final, resid(.,type="p") ~ fitted(.) | temp_C, abline=0)

# plot of standardized residuals by nutrient trt
plot(ER_final, resid(.,type="p") ~ fitted(.) | nutrient_trt, abline=0)

# qq plot to assess normality of residuals
qqnorm(ER_final)
```

## estimated marginal means
```{r}
####################
# nutrient effect by season
nut_seasonal_ER <- emmeans(ER_final, pairwise ~ nutrient_trt|month, cov.keep = "temp_C", type = "response")

# saving contrasts from emmeans as dataframe so I can export a table of the results
nut_seasonal_ER <- nut_seasonal_ER$contrasts %>%
  as.data.frame() %>%
  mutate(across(c(ratio:p.value), ~signif(.,4))) # rounding numbers in all numeric columns to 4 sig figs

####################
# shows effect of month on ER averaged across all levels of temperature and nutrients, with direct pairwise comparisions between months.
emmeans(ER_final, pairwise ~ month, cov.keep = "temp_C", type = "response")



######################
# shows the interaction between month and temperature, with the difference slopes of temperature shown for each month
temp_seasonal_ER <- emtrends(ER_final, pairwise ~ month , var = "temp_C" )

temp_seasonal_ER_emm <- temp_seasonal_ER_emm$emtrends %>%
  as.data.frame() # saving emtrends contrasts as a dataframe so I can export results in a table

# printing table of data with associated Q10 values
temp_emmeans_table_ER <- temp_seasonal_ER_emm %>%
  mutate(temp_C.trend = exp(temp_C.trend)) %>% # putting the estimated temp trends in the response scale by undoing the log-transformation
   mutate(Q10_value = temp_C.trend^10) %>% # calculating Q10 values
   mutate(across(c(temp_C.trend:Q10_value), ~round(.,4))) %>% # rounding all numeric columns to 4 sig figs
    gt() %>%
  cols_move(columns = Q10_value, after = temp_C.trend) %>%
  cols_label(temp_C.trend = "temperature effect", Q10_value = html("Q<sub>10</sub> ")) %>%
  tab_header(title = "Seasonal Variation in Temperature Effects on Periphyton ER")
gtsave("plots/main_analysis/temp_seasonal_ER_emmeans.png", data = temp_emmeans_table_ER)



##################
# checking out temperature-nutrient interactions for each month
temp_nut_seasonal_ER <- emtrends(ER_final, pairwise ~ nutrient_trt | month, var = "temp_C")

################

# interaction plot of temp, nutrients, and month in log scale
ER_IP <- emmip(ER_final, nutrient_trt ~ temp_C|month, CIs = FALSE, cov.keep = c("temp_C", "nutrient_trt")) +
  geom_point(aes(x = temp_C, y = log(ER_mgO2_d_gAFDW_2), color = nutrient_trt), data = dat_lme, inherit.aes = FALSE) +
  facet_grid(cols = vars(month)) +
  labs(y = expression(log(ER~(mgO[2]~day^{-1}~gAFDW^{-1}))), x = "") +
  scale_color_manual(values = c("#00BFC4", "#F8766D")) +
  theme_bw() +
  theme(legend.position = "none")

ggsave("plots/main_analysis/ER_IP.png", plot = ER_IP, width = 7, height = 3, dpi = 300)

```

# NEP
## model building
### Table E3
```{r}
# making new dataset for lme models to remove NAs and data from april 2021 experiments
dat_lme <- dat_clean %>%
  filter(!is.na(NEP_mgO2_d_gAFDW_2) & exp_ID > 4)

# converting experiment ID, nutrient_trt, and month from numeric to a factor so that they are coded as such in the model instead of as a character
dat_lme$exp_ID <- as.factor(dat_lme$exp_ID)
dat_lme$nutrient_trt <- as.factor(dat_lme$nutrient_trt)
dat_lme$month <- as.factor(dat_lme$month)

# reordering month variable so it graphs months in order
dat_lme$month <- factor(dat_lme$month, levels = c("february", "june", "august", "october", "november"))


levels(dat_lme$month)

# reordering nutrient trt variable so that enriched is first; this guarantees that the nutrient trt effect reported in the model summary reflects the effect of the enriched treatment rather than the ambient treatment
dat_lme$nutrient_trt <- factor(dat_lme$nutrient_trt, levels = c("ambient", "enriched"))


levels(dat_lme$nutrient_trt)

#glimpse(dat_lme)
#View(dat_lme)

# intercept- only model
m0 <- gls(log(NEP_mgO2_d_gAFDW_2) ~ 1, data = dat_lme)

# starting with as many explanatory variables as possible in the fixed effects component of the models (temp, nutrients, their interaction, and autotrophic index (AI))

m1 <- gls(log(NEP_mgO2_d_gAFDW_2) ~ temp_C * nutrient_trt * month, method = "REML", data = dat_lme)


# can put this into any of the lme model code below to get model summaries in sum contrast form:
# contrasts = list(month = contr.sum, nutrient_trt = contr.sum)


m2 <- lme(log(NEP_mgO2_d_gAFDW_2) ~ temp_C * nutrient_trt * month, random = ~ 1 | rock_ID, data = dat_lme) # adding in random intercept for each rock sample

m3 <- lme(log(NEP_mgO2_d_gAFDW_2) ~ temp_C * nutrient_trt * month, random = ~ 1 | rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme) # incorporating weights to account for heteroscedasticity within and btwn different experiments

m4 <- lme(log(NEP_mgO2_d_gAFDW_2) ~ temp_C * nutrient_trt * month, random = ~ 1 + temp_C | rock_ID, data = dat_lme, control=(msMaxIter=1000)) # adding in random intercept and slope for each rock sample, also increasing the number of iterations to acheive model convergence
# does not converge


m5 <- lme(log(NEP_mgO2_d_gAFDW_2) ~ temp_C * nutrient_trt * month, random = ~ 1 + temp_C | rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme, control=(msMaxIter=1000)) # incorporating weights to account for heteroscedasticity within and btwn different experiments, also increasing the number of iterations to acheive model convergence
# including month as a fixed effect (interested in interpreting seasonal effects and interactions with temp and nutrient effects)
# coded in nutrient_trt as a factor instead of nutrients which is of class numeric
# used contrasts for month and nutrient_trt so that the coefficients were interpretable as the average of that effect over all the other variable combinations instead of in relation to the first default factor setting (ambient nutrients or the first month in the data set). This change got rid of covariance structure between temp_C and month in the model and made interpretations of the coefficients more intuitive.

# comparing AICs of models
AIC(m0, m1, m2, m3, m4, m5)

summary(m5)
NEP_final <- m5

# saving model object
saveRDS(NEP_final, "models/NEP_final_mod.rds")

# reading in final model 
NEP_final <- readRDS("models/NEP_final_mod.rds")

summary(NEP_final)

tab_model(m0, m1, m2, m3, m4, m5, dv.labels = c("Intercept only", "GLS", "LMM1", "LMM2", "LMM3", "LMM4"),
  show.ci = FALSE,
  show.aic = T,
  p.style = "stars",
  transform = "exp",
  file = "plots/final_paper/TableE3.doc")


# updating NEP model to add contrast sums using update()
# this will make the fixed effect estimates be relative to the grand mean which can aid in interpretation
NEP_new <- update(NEP_final, ~ contrasts = list(month = contr.sum, nutrient_trt = contr.sum))
summary(NEP_new)
```

## model diagnostics
```{r}
plot(NEP_final)

# plot of standardized residuals by month
plot(NEP_final, resid(.,type="p") ~ fitted(.) | month, abline=0)

# plot of standardized residuals by temperature trt
plot(NEP_final, resid(.,type="p") ~ fitted(.) | temp_C, abline=0)

# plot of standardized residuals by nutrient trt
plot(NEP_final, resid(.,type="p") ~ fitted(.) | nutrient_trt, abline=0)

# qq plot to assess normality of residuals
qqnorm(NEP_final)
```

## estimated marginal means
```{r}
####################
# nutrient effect by season
nut_seasonal_NEP <- emmeans(NEP_final, pairwise ~ nutrient_trt|month, cov.keep = "temp_C", type = "response")


nut_seasonal_NEP <- nut_seasonal_NEP$contrasts %>%
  as.data.frame() %>% # saving contrasts from emmeans as dataframe so I can export a table of the results
  mutate(across(c(ratio:p.value), ~signif(.,4))) # rounding numbers in all numeric columns to 4 sig figs

#######################
# shows effect of month on NEP averaged across all levels of temperature and nutrients, with direct pairwise comparisions between months.
emmeans(NEP_final, pairwise ~ month, cov.keep = "temp_C", type = "response")




###################
# shows the interaction between month and temperature, with the difference slopes of temperature shown for each month
temp_seasonal_NEP <- emtrends(NEP_final, pairwise ~ month , var = "temp_C" )


temp_seasonal_NEP_emm <- emtrends(NEP_final, pairwise ~ month, var = "temp_C")

# saving emtrends contrasts as a dataframe so I can export results in a table
temp_seasonal_NEP_emm <- temp_seasonal_NEP_emm$emtrends %>%
  as.data.frame()

# printing table of data with associated Q10 values
temp_emmeans_table_NEP <- temp_seasonal_NEP_emm %>%
  mutate(temp_C.trend = exp(temp_C.trend)) %>% # putting the estimated temp trends in the response scale by undoing the log-transformation
   mutate(Q10_value = temp_C.trend^10) %>% # calculating Q10 values
   mutate(across(c(temp_C.trend:Q10_value), ~round(.,4))) %>% # rounding all numeric columns to 4 sig figs
    gt() %>%
  cols_move(columns = Q10_value, after = temp_C.trend) %>%
  cols_label(temp_C.trend = "temperature effect", Q10_value = html("Q<sub>10</sub> ")) %>%
  tab_header(title = "Seasonal Variation in Temperature Effects on Periphyton NEP")
gtsave("plots/main_analysis/temp_seasonal_NEP_emmeans.png", data = temp_emmeans_table_NEP)


#####################
# checking out temperature-nutrient interactions for each month
temp_nut_seasonal_NEP <- emtrends(NEP_final, pairwise ~ nutrient_trt | month, var = "temp_C") 

#######################

# interaction plot of temp, nutrients, and month in log scale
NEP_IP <- emmip(NEP_final, nutrient_trt ~ temp_C|month, CIs = FALSE, cov.keep = c("temp_C", "nutrient_trt")) +
  geom_point(aes(x = temp_C, y = log(NEP_mgO2_d_gAFDW_2), color = nutrient_trt), data = dat_lme, inherit.aes = FALSE) +
  facet_grid(cols = vars(month)) +
  labs(y = expression(log(NEP~(mgO[2]~day^{-1}~gAFDW^{-1}))), x = expression('Temperature (\u00B0C)')) +
  scale_color_manual("Nutrient Treatment", values = c("#00BFC4", "#F8766D")) +
  theme_bw() +
  theme(legend.position = "bottom")

ggsave("plots/main_analysis/NEP_IP.png", plot = NEP_IP, width = 7, height = 3, dpi = 300)
```

# Stacking plots
#### Figure 4
```{r}
# combining emmip plots for GPP, ER, and NEP
library(patchwork)

metab_IP <- (GPP_IP/ER_IP/ NEP_IP)

ggsave("plots/main_analysis/metab_IP.jpg", plot = metab_IP, height = 8, width = 7, dpi = 300)

ggsave("plots/final_paper/Figure4.jpg", plot = metab_IP, height = 8, width = 7, dpi = 300)
```

### Model Summary Table
#### Table 2
```{r}
tab_model(GPP_final, ER_final, NEP_final, dv.labels = c("GPP", "ER", "NEP"),
  show.ci = FALSE, 
  p.style = "stars", 
  transform = "exp",
  file = "plots/final_paper/Table1.doc")
```


##### contrast sums summary table
```{r}
# updating models to add contrast sums using update()
# this will make the fixed effect estimates be relative to the grand mean which can aid in interpretation
# need to run code in model building chunks to generate the dataframe used to create these models
ER_new <- update(ER_final, contrasts = list(month = contr.sum, nutrient_trt = contr.sum))
GPP_new <- update(GPP_final, contrasts = list(month = contr.sum, nutrient_trt = contr.sum))
NEP_new <- update(NEP_final, contrasts = list(month = contr.sum, nutrient_trt = contr.sum))

tab_model(GPP_new, ER_new, NEP_new, dv.labels = c("GPP", "ER", "NEP"),
  show.ci = FALSE, 
  p.style = "stars", 
  transform = "exp")
```

