---
title: "Lahontan Nutrient Uptake Analysis"
author: "Nick Framsted"
date: "9/29/2021"
output: html_document
---

```{r setup, include=FALSE}
library(ggplot2)
library(tidyverse)
library(lubridate)
library(ggpubr)
library(plotly)
library(reshape2)
library(DescTools)
library(arm)
library(lme4)
library(lattice)

# changing working directory from /scripts to /tahoe_lab_inc_analysis
knitr::opts_knit$set(root.dir = '..')
```

# Loading and formatting dataframe
```{r, include = FALSE}
# importing nutrient data
dat <- read_csv("data/nutrient_data/210928_nutrientdata_mar_aug_R.csv", skip = 2)
head(dat)


# reformatting date column into datetimes in POSIXct
dat$date <- mdy_hm(dat$date)

#renaming date column as datetime and creating a separate data column without the time
dat <- dat %>%
  rename(datetime = date) %>%
  mutate(date = date(datetime))
#View(dat)
```

# Creating dataframe containing field nutrient concentrations only
```{r}
ambient_nutrients <- dat %>%
  filter(site_treatment == "TPI_TC_NA" | site_treatment == "TPI_PNLD_0.5m")

#View(ambient_nutrients)
```

The nutrient data for the 3/15/21 experiment at Tahoe City was taken from 0.45um-filtered water instead of raw water since all water was mistakenly filtered before nutrient analysis were completed.

# Calculating nutrient uptake rates by temperature
```{r}
# dataframe of starting (initial) nutrient concentrations
bulk <- dat %>%
  filter(site_treatment == "TPI_TC_Bulk" | site_treatment == "TPI_PNLD_bulk" & chamber != "T_bulk_1") %>% #filtering out T_bulk_1 since this nutrient sample was taken too long before the start of the experiment to be accurate
  dplyr::select(date, NO3_N_py, NH4_N, SRP, DP) %>% # selecting only nutrient data columns
  rename(bulk_NO3_N_py = NO3_N_py, bulk_NH4_N = NH4_N, bulk_SRP = SRP, bulk_DP = DP) %>% # renaming columns to indicate these were the initial concentrations for joining to the uptake dataframe
  slice(-c(6)) # removing 6th row since this was an extra bulk sample taken for the nov 2021 experiment

# added in values for bulk concentrations in excel for 6/13 and 8/8 experiments since these were reported as TNO3, TNH4, TRP, and TP instead of the dissolved concentrations in previous experiments

#View(bulk)




# dataframe of final nutrient concentrations in enriched chambers
uptake <- dat %>%
  filter(site_treatment == "TPI_PNLD_E" | site_treatment == "TPI_TC_E") %>%
  unite(date_chamber, date, chamber, sep = "_", remove = "FALSE") %>% # combining columns so I can assign temperature treatments to each individual row from recorded treatments in experimental notes
  mutate(
    temp_C = case_when(
      date_chamber == "2021-03-15_F_15" |
        date_chamber == "2021-03-15_F_7"|
        date_chamber == "2021-03-15_F_6"|
        date_chamber == "2021-03-15_F_5"|
        date_chamber == "2021-04-21_F_2"|
        date_chamber == "2021-04-21_F_5"|
        date_chamber == "2021-04-21_F_15"|
        date_chamber == "2021-04-21_F_1" ~ 7,
      date_chamber == "2021-03-15_F_9"|
        date_chamber == "2021-03-15_F_1"|
        date_chamber == "2021-03-15_F_8"|
        date_chamber == "2021-03-15_F_12"|
        date_chamber == "2021-04-21_F_11"|
        date_chamber == "2021-04-21_F_6"|
        date_chamber == "2021-04-21_F_12"|
        date_chamber == "2021-04-21_F_14" ~ 10,
      date_chamber == "2021-03-15_F_3" |
        date_chamber == "2021-03-15_F_2" |
        date_chamber == "2021-03-15_F_4" |
        date_chamber == "2021-03-15_F_10" |
        date_chamber == "2021-04-21_F_16"|
        date_chamber == "2021-04-21_F_3"|
        date_chamber == "2021-04-21_F_10"|
        date_chamber == "2021-04-21_F_9" ~ 13,
      date_chamber == "2021-03-15_F_16" |
        date_chamber == "2021-03-15_F_11" |
        date_chamber == "2021-03-15_F_13" |
        date_chamber == "2021-03-15_F_14" |
        date_chamber == "2021-04-21_F_7"|
        date_chamber == "2021-04-21_F_13"|
        date_chamber == "2021-04-21_F_8"|
        date_chamber == "2021-04-21_F_4" ~ 16,
      date_chamber == "2021-06-13_F_5"|
        date_chamber == "2021-06-13_F_9"|
        date_chamber == "2021-06-13_F_10"|
        date_chamber == "2021-06-13_F_16" ~ 14.5,
      date_chamber == "2021-06-13_F_6"|
        date_chamber == "2021-06-13_F_7"|
        date_chamber == "2021-06-13_F_13"|
        date_chamber == "2021-06-13_F_14" ~ 17.5,
      date_chamber == "2021-06-13_F_3"|
        date_chamber == "2021-06-13_F_4"|
        date_chamber == "2021-06-13_F_11"|
        date_chamber == "2021-06-13_F_15" ~ 20.5,
      date_chamber == "2021-06-13_F_1"|
        date_chamber == "2021-06-13_F_2"|
        date_chamber == "2021-06-13_F_8"|
        date_chamber == "2021-06-13_F_12" ~ 23.5,
      date_chamber == "2021-08-08_F_3"|
        date_chamber == "2021-08-08_F_5"|
        date_chamber == "2021-08-08_F_7"|
        date_chamber == "2021-08-08_F_14"|
        date_chamber == "2021-08-08_F_A_35" ~ 19.5,
      date_chamber == "2021-08-08_F_1"|
        date_chamber == "2021-08-08_F_8"|
        date_chamber == "2021-08-08_F_11"|
        date_chamber == "2021-08-08_F_12"|
        date_chamber == "2021-08-08_F_A_37" ~ 22.5,
      date_chamber == "2021-08-08_F_4"|
        date_chamber == "2021-08-08_F_9"|
        date_chamber == "2021-08-08_F_13"|
        date_chamber == "2021-08-08_F_15"|
        date_chamber == "2021-08-08_F_A_25" ~ 25.5,
      date_chamber == "2021-08-08_F_2"|
        date_chamber == "2021-08-08_F_6"|
        date_chamber == "2021-08-08_F_10"|
        date_chamber == "2021-08-08_F_16"|
        date_chamber == "2021-08-08_F_A_13" ~ 28.5,
      date_chamber == "2021-10-10_F_1" |
        date_chamber == "2021-10-10_F_3" |
        date_chamber == "2021-10-10_F_7" |
        date_chamber == "2021-10-10_F_8" |
        date_chamber == "2021-10-10_F_J_45" ~ 18,
      date_chamber == "2021-10-10_F_5" |
        date_chamber == "2021-10-10_F_10" |
        date_chamber == "2021-10-10_F_12" |
        date_chamber == "2021-10-10_F_15" |
        date_chamber == "2021-10-10_F_J_13" ~ 15,
      date_chamber == "2021-10-10_F_2" |
        date_chamber == "2021-10-10_F_11" |
        date_chamber == "2021-10-10_F_13" |
        date_chamber == "2021-10-10_F_14" |
        date_chamber == "2021-10-10_F_J_28" ~ 21,
      date_chamber == "2021-10-10_F_4" |
        date_chamber == "2021-10-10_F_6" |
        date_chamber == "2021-10-10_F_9" |
        date_chamber == "2021-10-10_F_16" |
        date_chamber == "2021-10-10_F_JA_5" ~ 24,
      date_chamber == "2021-11-28_F_A_13" |
        date_chamber == "2021-11-28_F_5" |
        date_chamber == "2021-11-28_F_10" |
        date_chamber == "2021-11-28_F_12" |
        date_chamber == "2021-11-28_F_13" ~ 12.5,
      date_chamber == "2021-11-28_F_A_9" |
        date_chamber == "2021-11-28_F_3" |
        date_chamber == "2021-11-28_F_7" |
        date_chamber == "2021-11-28_F_15" |
        date_chamber == "2021-11-28_F_16" ~ 9.5,
      date_chamber == "2021-11-28_F_A_18" |
        date_chamber == "2021-11-28_F_1" |
        date_chamber == "2021-11-28_F_2" |
        date_chamber == "2021-11-28_F_4" |
        date_chamber == "2021-11-28_F_14" ~ 15.5,
      date_chamber == "2021-11-28_F_A_38" |
        date_chamber == "2021-11-28_F_6" |
        date_chamber == "2021-11-28_F_8" |
        date_chamber == "2021-11-28_F_9" |
        date_chamber == "2021-11-28_F_11" ~ 18.5
    )) # values double-checked by NTF on 1/10/22

#View(uptake)

# joining both the above dataframes (both initial and final nutrient concentrations) to calculate nutrient uptake rates from
uptake_rates <- left_join(uptake, bulk, by = "date")
#View(uptake_rates)

# adding in length of incubation period in hours to calculate uptake rates
# Uptake times for the 3/15, and 4/21 experiments are approximate since the exact start and finish times were not logged
uptake_rates <- uptake_rates %>%
  mutate(
    hrs = case_when(
      date == "2021-03-15" ~ 24.5,
      date == "2021-04-21" ~ 25.5,
      date == "2021-06-13" ~ 11,
      date == "2021-08-08" ~ 23,
      date == "2021-10-10" ~ 24,
      date == "2021-11-28" ~ 24
      )) %>%
  mutate(NO3_uptake_ug_N_hr = (bulk_NO3_N_py - NO3_N_py)/hrs, NH4_uptake_ug_N_hr = (bulk_NH4_N - NH4_N)/hrs, SRP_uptake_ug_P_hr = (bulk_SRP - SRP)/hrs, DP_uptake_ug_P_hr = (bulk_DP - DP)/hrs) %>% # calculating uptake rates per hour
  mutate(NO3_use_ug_N = bulk_NO3_N_py - NO3_N_py, NH4_use_ug_N = bulk_NH4_N - NH4_N, SRP_use_ug_P = bulk_SRP - SRP, DP_use_ug_P = bulk_DP - DP) # calculating drawdown in nutrients

#View(uptake_rates)
  
```

# Plotting nutrient uptake rates
```{r}
# melting dataframe to long format so that uptake rate columns are combined into one column and values are in a separate column so all can be plotted at once
dat_long <- uptake_rates %>%
  rename(NO3_rate = NO3_uptake_ug_N_hr, NH4_rate = NH4_uptake_ug_N_hr, SRP_rate = SRP_uptake_ug_P_hr, DP_rate = DP_uptake_ug_P_hr) %>% # renaming columns so that facet labels are more tidy
  pivot_longer(cols = c(NO3_rate, NH4_rate, SRP_rate, DP_rate),
               names_to = "uptake_rate_name",
               values_to = "rates",
               values_drop_na = TRUE)
#View(dat_long)

# adding in column to distinguish background jar uptake rates so they're plotted separately from august incubation rates
dat_long <- dat_long %>%
  mutate(
    date_background = case_when(
      chamber == "F_A_13" |
        chamber == "F_A_25" |
        chamber == "F_A_35" |
        chamber == "F_A_37" ~ "2021-08-08_background_rate",
      chamber == "F_JA_5" |
        chamber == "F_J_45" |
        chamber == "F_J_13" |
        chamber == "F_J_28" ~ "2021-10-10_background_rate",
      chamber == "F_A_13" |
        chamber == "F_A_9" |
        chamber == "F_A_18" |
        chamber == "F_A_38" ~ "2021-11-28_background_rate",
      TRUE ~ as.character(date)
    )
  )
#View(dat_long)

# formatting date column to be a discrete variable for plotting purposes
dat_long$date <- as.character(dat_long$date)

# plotting nutrient uptake rates
p <- dat_long %>%
  ggplot(aes(x = temp_C, y = rates)) +
  facet_grid(cols = vars(uptake_rate_name)) +
  geom_point(aes(group = date_chamber, color = date_background)) +
  geom_smooth(aes(color = date_background), method = "lm") +
  scale_color_viridis_d("Experiment Date") +
  theme_bw() +
  labs(title = "Periphyton Nutrient Uptake Rates vs. Temperature",
      x = expression('Temperature (\u00B0C)'),
      y = expression(Nutrient~Uptake~(ugN/ugP~hr^{-1})))
p

# making plotly plot to investigate individual datapoints
p <- plotly::ggplotly(p)
p


```

Important things to keep in mind: 1) The April experiment had much lower initial nutrient concentrations than the other experiments and nutrients were virtually exhausted in these chambers. 
2) The June experiment only had an 11-hr incubation, which was about half as long as the ~24hr incubation period in the other experiments
3) The March 2021 experiment had slightly higher nutrient enrichment concentrations, and the stoichiometry of N & P in the additions were slightly different as well.

# Plotting AFDW-normalized nutrient uptake rates
```{r}
# prepping nutrient data for joining to incubation AFDW data
# creating numeric chamber column in nutrient data and removing the "F_" from individual cells
dat_long <- dat_long %>%
  mutate(chamber_num = as.numeric(gsub("F_", "", chamber))) %>% #removing unwanted characters
  unite(chamber_ID, date, chamber_num, sep = "_", remove = "FALSE") # combining date and chamber number columns for use in joining AFDW data from previous incubations

#View(dat_long)


# prepping AFDW data for joining
# creating chamber_ID column same as in above dataframe which will serve as a unique identifier for each chamber in each incubation and will be used to index the joining of the two dataframes
metab_dat <- read_csv("data/main_analysis/main_rate_data.csv")

metab_dat <- metab_dat %>%
  mutate(date = c(rep("2021-03-01", 16), rep("2021-03-15", 16), rep("2021-04-07", 16), rep("2021-04-21", 16), rep("2021-06-13", 32), rep("2021-08-08", 32), rep("2021-10-10", 32), rep("2021-11-28", 32))) %>% # creating date column
  unite(chamber_ID, date, chamber, sep = "_", remove = "FALSE") %>%# combining date and chamber columns
  dplyr::select(chamber_ID, total_AFDW_g, rock_SA_m2, GPP_mg_d, ER_mg_d, NEP_mg_d) # selecting only the columns I need to declutter dataframe a bit

#View(metab_dat)



# Joining the nutrient and metab data frames
main <- left_join(dat_long, metab_dat, by = "chamber_ID")
#View(main)


# calculating AFDW-normalized rates
main <- main %>%
  mutate(AFDW_rates = rates/total_AFDW_g)

# plotting AFDW_normalized rates
# plotting nutrient uptake rates
AFDW <- main %>%
  filter(date != "2021-04-21" & uptake_rate_name != "DP_rate" & AFDW_rates < 600) %>% # filtering out april 2021 data since rates were near zero due to error with nutrient enrichment, also filtering out DP data, and filtering out outlier from nov 2021 experiment
  ggplot(aes(x = temp_C, y = AFDW_rates)) +
  facet_grid(cols = vars(uptake_rate_name)) +
  geom_point(aes(group = date_chamber, color = date_background)) +
  geom_smooth(aes(color = date_background), method = "lm") +
  scale_color_viridis_d("Experiment Date") +
  theme_bw() +
  theme(legend.position = "bottom") +
  labs(title = "AFDW-Normalized Periphyton Nutrient Uptake Rates vs. Temperature",
      x = expression('Temperature (\u00B0C)'),
      y = expression(Nutrient~Uptake~(ugN/ugP~gAFDW^{-1}~hr^{-1})))
AFDW

ggsave("plots/nutrient_uptake/AFDW_norm_uptake_rates.png", plot = AFDW, width = 7, height = 4, dpi = 300)

```

# Molar nutrient uptake plot
```{r}
#View(main)
molar <- main %>%
  filter(uptake_rate_name != "DP_rate" & AFDW_rates <600) %>% # filtering out DP uptake rates since chemical there is no single chemical formula for this P species to calculate molar uptake rate with, also filtering out outlier from nov 2021 experiment
  mutate(molar_rate = case_when(
    uptake_rate_name == "NH4_rate" ~ AFDW_rates/14.0067e6,
    uptake_rate_name == "SRP_rate" ~ AFDW_rates/30.9738e6,
    uptake_rate_name == "NO3_rate" ~ AFDW_rates/14.0067e6
  ))

#View(molar_rate)

# plotting molar uptake rates per gAFDW of periphyton
AFDW_molar <- molar %>%
  ggplot(aes(x = temp_C, y = molar_rate)) +
  facet_grid(cols = vars(uptake_rate_name)) +
  geom_point(aes(group = date_chamber, color = date_background)) +
  geom_smooth(aes(color = date_background), method = "lm") +
  scale_color_viridis_d("Experiment Date") +
  theme_bw() +
  theme(legend.position = "bottom") +
  labs(title = "AFDW-Normalized Periphyton Nutrient Uptake Rates vs. Temperature",
      x = expression('Temperature (\u00B0C)'),
      y = expression(Nutrient~Uptake~(mol~gAFDW^{-1}~hr^{-1})))
AFDW_molar

ggsave("plots/nutrient_uptake/molar_AFDW_norm_uptake_rates.png", plot = AFDW_molar, width = 7, height = 4, dpi = 300)
```

# Molar ratio of nutrient uptake plot
```{r}
molar_ratio <- uptake_rates %>%
  mutate(NO3_uptake_mol_hr = NO3_uptake_ug_N_hr/14.0067e6, NH4_uptake_mol_hr = NH4_uptake_ug_N_hr/14.0067e6, SRP_uptake_mol_hr = SRP_uptake_ug_P_hr/30.9738e6)

molar_ratio <- molar_ratio %>%
  mutate(uptake_N_P_mol_ratio = (NO3_uptake_mol_hr + NH4_uptake_mol_hr)/SRP_uptake_mol_hr)

head(molar_ratio)

# making date column a factor for plotting with discrete color scale
class(molar_ratio$date)
molar_ratio$date <- as.factor(molar_ratio$date)

mol_ratio_plot <- molar_ratio %>%
  filter(uptake_N_P_mol_ratio < 30 & uptake_N_P_mol_ratio > 0) %>% # filtering out 2 outliers from aug 2021 experiment
  ggplot(aes(x = temp_C, y = uptake_N_P_mol_ratio)) +
  geom_point(aes(group = date_chamber, color = date)) +
  geom_smooth(aes(color = date), method = "lm") +
  scale_color_viridis_d("Experiment Date") +
  theme_bw() +
  theme(legend.position = "bottom") +
  labs(title = "Periphyton Nutrient Uptake Molar Ratio vs. Temperature",
      x = expression('Temperature (\u00B0C)'),
      y = expression(Molar~Ratio~of~Nutrient~Uptake~(mol~N:mol~P)))
mol_ratio_plot

ggsave("plots/nutrient_uptake/uptake_molar_ratio.png", plot = mol_ratio_plot, width = 7, height = 4, dpi = 300)
```

