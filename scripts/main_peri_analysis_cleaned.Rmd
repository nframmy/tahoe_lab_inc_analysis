---
title: "main_peri_analysis_v2"
author: "Nick Framsted"
date: "4/5/2022"
output: html_document
---

Analysis of all Tahoe Periphyton Metabolism Data

Input data files: Individual dataframes generated from separate analyses of each incubation.

Output data files: Main dataframe of combined dataframes from each incubation.

```{r setup, include=FALSE}
library(ggplot2)
library(tidyverse)
library(lubridate)
library(ggpubr)
library(plotly)
library(reshape2)
library(DescTools)
library(arm)
library(nlme)
library(lattice)
library(emmeans)
library(sjPlot)
library(sjmisc)
library(sjlabelled)
library(patchwork)
library(gt)

# changing working directory from /scripts to /tahoe_lab_inc_analysis
knitr::opts_knit$set(root.dir = '..')
```

# Loading and formatting dataframe
```{r, include = FALSE}
# importing, cleaning up, and combining metabolism data from all incubations
### 210301-210315 TC Ambient & Enriched data
dat1 <- read_csv("data/main_analysis/210301_210315_TC_A_E_rates.csv")


### 210407-210421 Pineland A & E data
dat2 <- read_csv("data/main_analysis/210407_210421_pnld_A_E_rates.csv")


### 210613 Pineland A & E data

dat3 <- read_csv("data/main_analysis/210613_pnld_A_E_rates.csv")

### 210808 Pineland A & E data

dat4 <- read_csv("data/main_analysis/210808_pnld_A_E_rates.csv")


### 211010 Pineland A & E data

dat5 <- read_csv("data/main_analysis/211010_pnld_A_E_rates.csv")


### 211128 Pineland A & E data
dat6 <- read_csv("data/main_analysis/211128_pnld_A_E_rates.csv")

### 220227 Pineland A & E data
dat7 <- read_csv("data/main_analysis/220227_pnld_A_E_rates.csv")



########## Data Formatting #############

dat1 <- dat1 %>%
  mutate(season = "spring", month = "march") # adding season and month columns to dataframe



dat2 <- dat2 %>%
  mutate(season = "spring", month = "april")


dat3 <- dat3 %>%
  mutate(season = "summer", month = "june")


dat4 <- dat4 %>%
  mutate(season = "summer", month = "august")

dat5 <- dat5 %>%
  mutate(season = "fall", month = "october")

dat6 <- dat6 %>%
  mutate(season = "winter", month = "november")

dat7 <- dat7 %>%
  mutate(season = "spring", month = "february")

######### Combining dataframes #########
dat <- bind_rows(dat1, dat2, dat3, dat4, dat5, dat6, dat7)
head(dat)

# adding in raw nutrient concentrations of ambient and enriched water for each experiment
dat <- dat %>%
  mutate(NO3_N_ug_L = case_when(
    nutrient_trt == "ambient" & month == "march" ~ 1.41,
    nutrient_trt == "enriched" & month == "march" ~ 534.89,
    nutrient_trt == "ambient" & month == "april" ~ 7.03,
    nutrient_trt == "enriched" & month == "april" ~ 45.19,
    nutrient_trt == "ambient" & month == "june" ~ 11.01,
    nutrient_trt == "enriched" & month == "june" ~ 374.8,
    nutrient_trt == "ambient" & month == "august" ~ 7.5,
    nutrient_trt == "enriched" & month == "august" ~ 387.33,
    nutrient_trt == "ambient" & month == "october" ~ 4.53,
    nutrient_trt == "enriched" & month == "october" ~ 376.76
  ),
  NH4_N_ug_L = case_when(
    nutrient_trt == "ambient" & month == "march" ~ 0.39,
    nutrient_trt == "enriched" & month == "march" ~ 571.52,
    nutrient_trt == "ambient" & month == "april" ~ 1.22,
    nutrient_trt == "enriched" & month == "april" ~ 45.31,
    nutrient_trt == "ambient" & month == "june" ~ 0, # if concentrations were negative, I entered them in as 0
    nutrient_trt == "enriched" & month == "june" ~ 395.58,
    nutrient_trt == "ambient" & month == "august" ~ 4.57,
    nutrient_trt == "enriched" & month == "august" ~ 416.04,
    nutrient_trt == "ambient" & month == "october" ~ 5.03,
    nutrient_trt == "enriched" & month == "october" ~ 438.69
  ),
  SRP_ug_L = case_when(
    nutrient_trt == "ambient" & month == "march" ~ 2.77,
    nutrient_trt == "enriched" & month == "march" ~ 823.85,
    nutrient_trt == "ambient" & month == "april" ~ 2.53,
    nutrient_trt == "enriched" & month == "april" ~ 67.91,
    nutrient_trt == "ambient" & month == "june" ~ 3.17,
    nutrient_trt == "enriched" & month == "june" ~ 315.47,
    nutrient_trt == "ambient" & month == "august" ~ 5.43,
    nutrient_trt == "enriched" & month == "august" ~ 320.3,
    nutrient_trt == "ambient" & month == "october" ~ 3.41,
    nutrient_trt == "enriched" & month == "october" ~ 325.74
  ))


####### Adding in Unique Chamber ID for each Experiment #########
dat <- dat %>%
  mutate(exp_ID = case_when(
    nutrients == 0 & month == "march" ~ 1,
    nutrients == 1 & month == "march" ~ 2, # since these were separate experiments on different periphyton samples, they get unique experiment IDs
    nutrients == 0 & month == "april" ~ 3,
    nutrients == 1 & month == "april" ~ 4,
    month == "june" ~ 5, # june, aug, and oct experiments used same rocks and chamber assignments for ambient and enriched runs, so it gets the same experiment ID
    month == "august" ~ 6,
    month == "october" ~ 7,
    month == "november" ~ 8,
    month == "february" ~ 9
  ))

# Creating rock_ID column
# using chamber and experiment # columns to give a unique code for each individual rock (this will indicate some sort of chamber or rock effect from repeated measures during the ambient and enriched nutrient runs)

dat <- dat %>%
  mutate(rock_ID = case_when(
    exp_ID == 5 & nutrients == 1 ~ row_number() - 16, # accouting for repeated measures on same rocks for the 5,6, and 7th experiments
    exp_ID == 6 & nutrients == 0 ~ row_number() - 16,
    exp_ID == 6 & nutrients == 1 ~ row_number() - 32,
    exp_ID == 7 & nutrients == 0 ~ row_number() - 32,
    exp_ID == 7 & nutrients == 1 ~ row_number() - 48,
    exp_ID == 8 & nutrients == 0 ~ row_number() - 48,
    exp_ID == 8 & nutrients == 1 ~ row_number() - 64,
    exp_ID == 9 & nutrients == 0 ~ row_number() - 64,
    exp_ID == 9 & nutrients == 1 ~ row_number() - 80,
     TRUE ~ as.double(row_number())
    ))
#View(dat)

# making rock_ID column a factor instead of numeric for analysis
dat$rock_ID <- as.factor(dat$rock_ID)



```


# Adding in Chla data
```{r}
####### Adding chla data by rock_ID ############

chla_main <- read_csv("data/main_analysis/chla_main_data.csv")

# formatting date column to be a date instead of a character class
chla_main$date <- mdy(chla_main$date)
head(chla_main)

# Creating rock_ID column
# using chamber and experiment # columns to give a unique code for each individual rock (this will indicate some sort of chamber or rock effect from repeated measures during the ambient and enriched nutrient runs)

chla_main <- chla_main %>%
  mutate(rock_ID = as.double(row_number())
    )
#View(chla_main)

# making rock_ID column a factor instead of numeric for analysis
chla_main$rock_ID <- as.factor(chla_main$rock_ID)

# trimming off chamber column so there aren't duplicate columns in the main dataframe

chla_main <- chla_main %>%
  dplyr::select(total_chla_ug, date, rock_ID)

# combining chla and main data by rock ID

dat <- left_join(dat, chla_main, by = "rock_ID")
#View(dat)


```

# Adding in corrected AFDW data
```{r}
######### Calculating Corrected AFDW data ###############

# since PES drying oven was found to be not operating at correct temperatures after the 11/28/21 experiment, all AFDW samples up to this point had to be redone to ensure they were ashed at proper temperatures

# As a result, we remeasured AFDW of all samples using left-over frozen sample; however, wet wts were found to no longer be accurate due to slight decrease in the water content of samples that had been frozen.

# Since we could no longer scale up these re-measured AFDW samples by wet weight, we chose to scale them up by dry weight. We were able to do this because dry weights from the first set of AFDW samples were still accurate, allowing us to calulate total Dry wt of samples by scaling up using the recorded wet wts of the fresh samples.

# We then use these total dry wts calculated by the first set of AFDW samples to scale up the re-measured AFDW samples using their recorded dry wts (SDW_60C_g).

# These corrected AFDW samples will be stored in a column titled "total_AFDW_g" and will replace the previous column of incorrect AFDW data of the same name.

# loading in re-measured AFDW data
afdw_main <- read_csv("data/main_analysis/AFDW_main_dat.csv", skip = 1)


# Creating rock_ID column
# using chamber and experiment # columns to give a unique code for each individual rock (this will indicate some sort of chamber or rock effect from repeated measures during the ambient and enriched nutrient runs)

afdw_main <- afdw_main %>%
  mutate(rock_ID = as.double(row_number() + 16)) # adding 16 to rock_ID to account for lack of re-measured afdw data for the 3/1/21 experiment in this dataset
         
#View(afdw_main)

# making rock_ID column a factor instead of numeric for analysis
afdw_main$rock_ID <- as.factor(afdw_main$rock_ID)

# selecting only columns I need

afdw_main <- afdw_main %>%
  dplyr::select(SDW_60C_g, SCW_500C_g, rock_ID)

# combining afdw and main data by rock ID column

dat <- left_join(dat, afdw_main, by = "rock_ID")

# calculating corrected AFDW data and recalculating AFDW-normalized metabolic rates
dat <- dat %>%
  mutate(total_AFDW_g_2 = case_when(
    exp_ID == 1 ~ total_AFDW_g, # using old AFDW data since there was no leftover sample
    TRUE ~ (total_DW_g/SDW_60C_g) * (SDW_60C_g - SCW_500C_g)
    )) %>% # recalculating AFDW using new data and scaling up based on previous estimates of total Dry weight
  mutate(GPP_mgO2_d_gAFDW_2 = GPP_mg_d/total_AFDW_g_2, NEP_mgO2_d_gAFDW_2 = NEP_mg_d/total_AFDW_g_2, ER_mgO2_d_gAFDW_2 = ER_mg_d/total_AFDW_g_2) # using corrected AFDW data to calculate AFDW-normalized metabolic rates

#View(dat)
   


```

# Calculating Autotrophic index
```{r}
# calculating the autotrophic index (ratio of AFDW:chl-a) (Biggs & Close 1989)

dat <- dat %>%
  mutate(AI = total_AFDW_g_2/(total_chla_ug/1e6)) # converting chla from ug to g so that the units cancel (g/g) in the AI ratio
```


# Adding in PP data
```{r}
# reading in compiled particulate phosphorus data file
PP <- read_csv("data/nutrient_data/PP_main_R.csv", skip = 1)

PP$date <- lubridate::mdy(PP$date) # formatting date column so that its of date class and not a character

# formatting columns to match main data frame
PP <- PP %>%
  filter(!grepl("0.5", sample_2) & chamber != "14_and_15") %>% # filtering out rows of in-situ lake PP concentrations and row of data with an analyitical error
  mutate(chamber = ifelse(grepl("_1", chamber), gsub('.{2}$', '', chamber), chamber)) %>% # some samples have 2 replicates analyzed using 2 different filtering methods, and we want to keep the data from the samples labeled with "_1". Thus, we're formatting the rows with "_1" in the chamber column to just have chamber number and remove the "_1" characters at the end of the string
  filter(!grepl("_2", chamber)) %>% # filtering out the replicates with "_2" in the chamber column. These rows correspond to replicates that used the filtering method we dont want to use data from.
  unite(date_chamber, date, chamber, sep = "_", remove = F) %>% # making a combined column of dates and chambers for use in combining with main dataframe
  dplyr::select(date_chamber, ug_P_per_liter_ppb, ug_P_per_gram_periphyton) # selecting only the colmns I need

#View(PP)

dat <- dat %>%
  mutate(date = lubridate::date(date)) %>%
  unite(date_chamber, date, chamber, sep = "_", remove = F) # adding a date_chamber column to main dataframe as well

dat <- left_join(dat, PP, by = "date_chamber") # joining particulate phosphorus data to dataframe

dat <- dat %>%
  rename(periphyton_PP_ug_L = ug_P_per_liter_ppb, periphyton_PP_ug_g = ug_P_per_gram_periphyton) %>% # renaming columns in dataframe
  dplyr::select(-date_chamber) # removing this indexing column as its not longer needed
#View(dat)
```


# COMBINING NUTRIENT UPTAKE RATE DATAFRAME WITH MAIN DATA
```{r}
# loading in nutrient uptake rate data
nutrient_dat <- read_csv("data/nutrient_data/nutrient_data_lahontan.csv")

# making rock_ID column a factor variable in nutrient data so that it's compatible with the main dataframe
nutrient_dat$rock_ID <- as.factor(nutrient_dat$rock_ID)

# combining dataframes
main_dat <- left_join(dat, nutrient_dat, by = "rock_ID")


# making sure that ambient samples have "NA" for nutrient data and uptake rates in dataframe since this data only applies to enriched rocks
main_dat <- main_dat %>%
  mutate(across(c(NO3_N_py:DP_rate), ~ifelse(nutrient_trt == "ambient", NA, .))) # making values of NO3_N_py column and all columns to the right of it be NA for ambient nutrient samples

#View(main_dat)

main_dat <- main_dat %>%
  dplyr::select(-total_AFDW_g, -GPP_mgO2_d_gAFDW:-ER_mgO2_d_gAFDW, -SDW_60C_g, - SCW_500C_g, -NO3_N_py:-bulk_DP) # removing columns associated with incorrect AFDW data, and other unecessary columns

# exporting main dataframe
write_csv(main_dat, "data/main_analysis/main_data_lahontan.csv")
```



# Exporting and Cleaning data
```{r}
# exporting combined dataframe as .csv
write_csv(dat, "data/main_analysis/main_rate_data.csv")

#View(dat)

# removing data from march experiments since it was at a different site and had excessive variation in AFDW-normalized GPP rates due to a discrepancy in filtering methods
dat_pnld <- dat %>%
  filter(!month == "march")
#View(dat_pnld)
glimpse(dat_pnld)

# Chambers 1 and 3 appear to be outliers for the june ambient incubations, and will be removed in subsequent analyses.

# removing outliers
# chambers 15 and 2 in Nov 2021 experiments had unusually high values for both the ambient and enriched experiments and were thus removed from the analysis

dat_clean <- dat_pnld %>%
  filter(month != "june" | nutrients != 0 | chamber != 1) %>%
  filter(month != "june" | nutrients != 0 | chamber != 3) %>%
  filter(month != "november" | chamber != 2) %>%
  filter(month != "november" | chamber != 15)
#View(dat_clean)
```

# Plotting main data
## Comparing AFDW: original vs. corrected
```{r}
AFDW_plot <- dat_clean %>%
  ggplot(aes(x = total_AFDW_g, y = total_AFDW_g_2)) +
  geom_point() +
  geom_abline(aes(intercept = 0, slope = 1)) +
  geom_rug(sides = "bl") +
  labs(x = "Old AFDW", y = "Corrected AFDW", title = "Comparison of AFDW Data") +
  lims( x = c(0, 1.5), y = c(0, 1.5)) +
  theme_classic()
AFDW_plot

ggsave("plots/main_analysis/AFDW_comparison.png", plot = AFDW_plot, width = 3, height = 3)
```


## New AFDW-adjusted rate plot
```{r}
# remelting dataframe to long format so that metabolic rate columns are combined into one column and values are in a separate column so all can be plotted at once
dat_long <- dat_clean %>%
  rename(GPP = GPP_mgO2_d_gAFDW_2, ER = ER_mgO2_d_gAFDW_2, NEP = NEP_mgO2_d_gAFDW_2) %>% # renaming columns so that facet labels are more tidy
  pivot_longer(cols = c(NEP, GPP, ER),
               names_to = "rate_name_AFDW",
               values_to = "rates_AFDW",
               values_drop_na = TRUE)
#View(dat_long)

# making experiment ID column a factor instead of numeric since it is treated as discrete rather than continuous in the plot
dat_long$exp_ID <- as.factor(dat_long$exp_ID)

AFDW_2_log_rates <- dat_long %>%
  ggplot(aes(x = temp_C, y = rates_AFDW, group = interaction(exp_ID, nutrients))) +
  facet_grid(cols = vars(rate_name_AFDW)) +
  scale_y_log10() +
 geom_point(aes(shape = exp_ID, color = nutrient_trt), size = 1.5) +
  geom_smooth(aes(color = nutrient_trt), method = "lm", se = FALSE) +
  scale_color_viridis_d("Nutrient Treatment") + # renaming label of color legend
  scale_shape_discrete(name = "Experiment ID") +# renaming label of point shape legend
  scale_shape_manual(values = c(15:17, 3:5, 8)) +
  theme_minimal() +
  theme(legend.position = "bottom") +
  labs(x = expression('Temperature (\u00B0C)'),
      y = expression(Rates~(mgO[2]~day^{-1}~gAFDW^{-1})))

AFDW_2_log_rates

# high quality dpi plot
ggsave("plots/main_analysis/correct_AFDW_norm_rates.png", plot = AFDW_2_log_rates, width = 7, height = 3, dpi = 300)



# sample plot, but removing april experiments since they were excluded from models (due to different experimental design)

AFDW_2_log_rates_wo_april <- dat_long %>%
  filter(month != "april") %>%
  ggplot(aes(x = temp_C, y = rates_AFDW, group = interaction(exp_ID, nutrients))) +
  facet_grid(cols = vars(rate_name_AFDW)) +
  scale_y_log10() +
 geom_point(aes(shape = exp_ID, color = nutrient_trt), size = 1.5) +
  geom_smooth(aes(color = nutrient_trt), method = "lm", se = FALSE) +
  scale_color_viridis_d("Nutrient Treatment") + # renaming label of color legend
  scale_shape_manual(name = "Experiment ID", values = c(15:17, 3:5, 8)) + # renaming label of point shape legend
  theme_minimal() +
  theme(legend.position = "bottom") +
  labs(x = expression('Temperature (\u00B0C)'),
      y = expression(Rates~(mgO[2]~day^{-1}~gAFDW^{-1})))

AFDW_2_log_rates_wo_april

ggsave("plots/main_analysis/correct_AFDW_rates_wo_april.png", plot = AFDW_2_log_rates_wo_april, width = 8, height = 3, dpi = 300)



# same plot, but ungrouping by experiment ID and adding back in april 2021 data

metab_rates <- dat_long %>%
  ggplot(aes(x = temp_C, y = rates_AFDW, group = nutrients)) +
  facet_grid(cols = vars(rate_name_AFDW)) +
  scale_y_log10() +
 geom_point(aes(color = nutrient_trt), size = 1.5) +
  geom_smooth(aes(color = nutrient_trt), method = "lm", se = FALSE) +
  scale_color_viridis_d("Nutrient Treatment") + # renaming label of color legend
  theme_minimal() +
  theme(legend.position = "bottom") +
  labs(x = expression('Temperature (\u00B0C)'),
      y = expression(Rates~(mgO[2]~day^{-1}~gAFDW^{-1})))

metab_rates

# high quality dpi plot
ggsave("plots/main_analysis/AFDW_model_output_plot.png", plot = metab_rates, width = 7, height = 3, dpi = 300)


# plot with only march and april experiments to test for carry-over effects between ambient and enriched trials (samples from these experiments were independent between ambient and enriched trials and were incubated immediately with no hold-times between; however, samples were collected from the field 2 wks apart which could introduce variation in the periphyton communities being incubated)

AFDW_2_log_rates_april <- dat %>% # data frame with march data included
  filter(month != "june" | nutrients != 0 | chamber != 1) %>%
  filter(month != "june" | nutrients != 0 | chamber != 3) %>%
  filter(month != "november" | chamber != 2) %>%
  filter(month != "november" | chamber != 15) %>% #filtering out outliers
  filter(month == "april" | month == "march") %>% # only including data from march and april experiments
  rename(GPP = GPP_mgO2_d_gAFDW_2, ER = ER_mgO2_d_gAFDW_2, NEP = NEP_mgO2_d_gAFDW_2) %>% # renaming columns so that facet labels are more tidy
  pivot_longer(cols = c(NEP, GPP, ER),
               names_to = "rate_name_AFDW",
               values_to = "rates_AFDW",
               values_drop_na = TRUE) %>% # melting data so all 3 rates can be plotted at once
  mutate(exp_ID = as.factor(exp_ID)) %>% # making exp_ID a factor for plotting purposes
  ggplot(aes(x = temp_C, y = rates_AFDW, group = interaction(exp_ID, nutrients))) +
  facet_grid(cols = vars(rate_name_AFDW)) +
  scale_y_log10() +
 geom_point(aes(shape = exp_ID, color = nutrient_trt), size = 1.5) +
  geom_smooth(aes(color = nutrient_trt), method = "lm", se = FALSE) +
  scale_color_viridis_d("Nutrient Treatment") + # renaming label of color legend
  scale_shape_manual(name = "Experiment ID", values = c(15:17, 3:5, 8)) + # renaming label of point shape legend
  theme_minimal() +
  theme(legend.position = "bottom") +
  labs(x = expression('Temperature (\u00B0C)'),
      y = expression(Rates~(mgO[2]~day^{-1}~gAFDW^{-1})))

AFDW_2_log_rates_april

```


# Plotting Areal Rates
```{r}
# melting dataframe to long format so that metabolic rate columns are combined into one column and values are in a separate column so all can be plotted at once
dat_long_m2 <- dat_clean %>%
  rename(GPP = GPP_mgO2_d_m2, ER = ER_mgO2_d_m2, NEP = NEP_mgO2_d_m2) %>% # renaming columns so that facet labels are more tidy
  pivot_longer(cols = c(NEP, GPP, ER),
               names_to = "rate_name_m2",
               values_to = "rates_m2",
               values_drop_na = TRUE)
#View(dat_long_m2)

# making experiment ID column a factor instead of numeric since it is treated as discrete rather than continuous in the plot
dat_long_m2$exp_ID <- as.factor(dat_long_m2$exp_ID)

areal_rates_log_log_AGU <- dat_long_m2 %>%
  ggplot(aes(x = temp_C, y = rates_m2, group = interaction(exp_ID, nutrients))) +
  facet_grid(cols = vars(rate_name_m2)) +
  scale_y_log10() +
 geom_point(aes(shape = exp_ID, color = nutrient_trt), size = 1.5) +
  geom_smooth(aes(color = nutrient_trt), method = "lm") +
  scale_color_viridis_d("Nutrient Treatment") + # renaming label of color legend
  scale_shape_discrete(name = "Experiment ID") +# renaming label of point shape legend
  scale_shape_manual(values = c(0:6)) +
  theme_minimal() +
  theme(legend.position = "bottom") +
  labs(x = expression('Temperature (\u00B0C)'),
      y = expression(Rates~(mgO[2]~day^{-1}~m^{-2})))

areal_rates_log_log_AGU

ggsave("plots/main_analysis/areal_rates_unlogged_AGU.png", plot = areal_rates_log_log_AGU, width = 7, height = 3, dpi = 300)

# same plot, but removing april experiments since they were excluded from models (due to different experimental design)

areal_rates_log_wo_april <- dat_long_m2 %>%
  filter(month != "april") %>%
  ggplot(aes(x = temp_C, y = rates_m2, group = interaction(exp_ID, nutrients))) +
  facet_grid(cols = vars(rate_name_m2)) +
  scale_y_log10() +
 geom_point(aes(shape = exp_ID, color = nutrient_trt), size = 1.5) +
  geom_smooth(aes(color = nutrient_trt), method = "lm") +
  scale_color_viridis_d("Nutrient Treatment") + # renaming label of color legend
  scale_shape_manual(name = "Experiment ID", values = c(15:17, 3:5, 8)) + # renaming label of point shape legend
  theme_minimal() +
  theme(legend.position = "bottom") +
  labs(x = expression('Temperature (\u00B0C)'),
      y = expression(Rates~(mgO[2]~day^{-1}~m^{-2})))

areal_rates_log_wo_april

ggsave("plots/main_analysis/areal_rates_unlogged_wo_april.png", plot = areal_rates_log_wo_april, width = 8, height = 3, dpi = 300)



# same plot, but ungrouping by experiment ID and adding back in april 2021 data

areal_rates <- dat_long_m2 %>%
  ggplot(aes(x = temp_C, y = rates_m2, group = nutrients)) +
  facet_grid(cols = vars(rate_name_m2)) +
  scale_y_log10() +
 geom_point(aes(color = nutrient_trt), size = 1.5) +
  geom_smooth(aes(color = nutrient_trt), method = "lm", se = FALSE) +
  scale_color_viridis_d("Nutrient Treatment") + # renaming label of color legend
  theme_minimal() +
  theme(legend.position = "bottom") +
  labs(x = expression('Temperature (\u00B0C)'),
      y = expression(Rates~(mgO[2]~day^{-1}~m^{-2})))

areal_rates

ggsave("plots/main_analysis/SA_model_output.png", plot = areal_rates, width = 7, height = 3, dpi = 300)
```


# Chl-a-normalized GPP plot
```{r}
# normalizing GPP rates by mass of chla on rocks
chla_rates <- dat_clean %>%
  mutate(GPP_mgO2_d_ugChla = GPP_mg_d/(total_chla_ug/1e6)) #converting chla data from ug to g

# making experiment ID column a factor instead of numeric since it is treated as discrete rather than continuous in the plot
chla_rates$exp_ID <- as.factor(chla_rates$exp_ID)

# now plotting GPP rates vs. temp, and removing april 2021 data

GPP_chla <- chla_rates %>%
  filter(month != "april") %>%
  ggplot(aes(x = temp_C, y = GPP_mgO2_d_ugChla, group = interaction(exp_ID, nutrients))) +
  scale_y_log10() +
 geom_point(aes(shape = exp_ID, color = nutrient_trt), size = 1.5) +
  geom_smooth(aes(color = nutrient_trt), method = "lm") +
  scale_color_viridis_d("Nutrient Treatment") + # renaming label of color legend
  scale_shape_manual(name = "Experiment ID", values = c(15:17, 3:5, 8)) + # renaming label of point shape legend
  theme_minimal() +
  theme(legend.position = "bottom") +
  labs(x = expression('Temperature (\u00B0C)'),
      y = expression(GPP~(mgO[2]~day^{-1}~gChla^{-1})))

GPP_chla

ggsave("plots/main_analysis/GPP_chla.png", plot = GPP_chla, height = 4, width = 8)


```


# Autotrophic Index
```{r}
# Using the autotrophic index (ratio of AFDW:chl-a) (Biggs & Close 1989)
         
dat %>%
  group_by(date) %>%
  summarise(AI_avg = mean(AI), AI_sd = sd(AI)) %>%
  arrange(AI_avg)

```


# Exploratory Data Analysis
```{r}
# histogram of temperature data to check normality
dat_pnld %>%
  ggplot(aes(temp_C)) +
  geom_histogram()
# looks approximately like a normal distribution

# now checking normality in AFDW-normalized metabolic rates
dat_pnld %>%
  ggplot(aes(GPP_mgO2_d_gAFDW)) +
  geom_histogram()

dat_pnld %>%
  ggplot(aes(NEP_mgO2_d_gAFDW)) +
  geom_histogram()

dat_pnld %>%
  ggplot(aes(ER_mgO2_d_gAFDW)) +
  geom_histogram()
# some definite outliers present, also some potential for a right-skewed distn in the ER and GPP rates.

# cleveland plot
# dotchart(dat_pnld$)

# selecting only the numeric columns for calculating a correlation matrix
dat_cor <- dat_pnld %>%
  dplyr::select(temp_C, GPP_mgO2_d_gAFDW, NEP_mgO2_d_gAFDW, ER_mgO2_d_gAFDW, GPP_mgO2_d_m2, NEP_mgO2_d_m2, ER_mgO2_d_m2, NO3_N_ug_L, NH4_N_ug_L, SRP_ug_L)

# standardizing data with mean = 0, sd = 1 for correlation matrix
dat_cor <- scale(dat_cor)
#View(dat_cor)

# plotting correlation matrix of the data
cor(dat_cor, use = "complete.obs")

```


# Time-series plots
### chla
```{r}
### chlorophyll-a trends across time

chla_trends <- dat %>%
  filter(exp_ID != 1) %>% # filtering out march 1st data due to different chla sampling protocols used for this experiment
  mutate(chla_g_m2 = total_chla_ug/rock_SA_m2/1e6) %>% # calculating areal chlorophyll-a concentrations (per m2)
  ggplot(aes(x = date, y = chla_g_m2, group = date)) +
  geom_boxplot() +
  labs(x = "", y = expression(Periphyton~Chl-a~(g~m^{-2}))) +
  theme_classic()

chla_trends

# simplified plot w/o expressions for ggplotly

chla_plotly <- dat %>%
  filter(exp_ID != 1) %>% # filtering out march 1st data due to different chla sampling protocols used for this experiment
  mutate(chla_g_m2 = total_chla_ug/rock_SA_m2/1e6) %>% # calculating areal chlorophyll-a concentrations (per m2)
  ggplot(aes(x = date, y = chla_g_m2, group = date)) +
  geom_boxplot() +
  theme_classic()

p <- plotly::ggplotly(chla_plotly)
p
```


### AI
```{r}
# plotting changes in AI over the year

AI_trends <- dat %>%
  filter(exp_ID != 1) %>% # filtering out march 1st data due to different chla sampling protocols used for this experiment
  filter(AI < 5000) %>% # filtering out 2 outliers from october and march
  ggplot(aes(x = date, y = AI, group = date)) +
  geom_boxplot() +
  labs(x = "Date", y = "Periphyton Autotrophic Index (gAFDW:gChla)") +
  theme_classic()

AI_trends

ggsave("plots/main_analysis/AI_timeseries.png", plot = AI_trends, height = 4, width = 8, dpi = 300)
```

### AFDW
```{r}
# plotting changes in areal AFDW over the year

AFDW_trends <- dat %>%
  filter(exp_ID != 1) %>% # filtering out march 1st data due to different chla sampling protocols used for this experiment
  mutate(AFDW_g_m2 = total_AFDW_g_2/rock_SA_m2) %>%
  filter(AFDW_g_m2 <= 200) %>% # filtering out outlier from exp_ID 2
  ggplot(aes(x = date, y = AFDW_g_m2, group = date)) +
  geom_boxplot() +
  labs(x = "", y = expression(Periphyton~AFDW~(g~m^{-2}))) +
  theme_classic()

AFDW_trends

ggsave("plots/main_analysis/AFDW_timeseries.png", plot = AFDW_trends, height = 4, width = 8, dpi = 300)


# simplified plot for plotly
AFDW_plotly <- dat %>%
  filter(exp_ID != 1) %>% # filtering out march 1st data due to different chla sampling protocols used for this experiment
  mutate(AFDW_g_m2 = total_AFDW_g_2/rock_SA_m2) %>%
  filter(AFDW_g_m2 <= 200) %>% # filtering out outlier from exp_ID 2
  ggplot(aes(x = date, y = AFDW_g_m2, group = date)) +
  geom_boxplot() +
  theme_classic()

p <- plotly::ggplotly(AFDW_plotly)
p

# patching together AI and AFDW timeseries plots so that they share the same x-axis
library(patchwork)

AI_AFDW <- (chla_trends/AFDW_trends/AI_trends)

ggsave("plots/main_analysis/AI_AFDW_trends.png", plot = AI_AFDW, height = 8, width = 8, dpi = 300)
```


## Control rates across seasons
### AFDW-normalized
```{r}
metab_trend_AFDW <- dat_long %>%
  filter(exp_ID == 3 & temp_C ==7 | exp_ID == 5 & temp_C == 14.5 | exp_ID == 6 & temp_C == 19.5 | exp_ID == 7 & temp_C == 15 | exp_ID == 8 & temp_C == 9.5 | exp_ID == 9 & temp_C == 6) %>% # filtering only ambient and in-situ temperature data from all experiments except march one due to different biomass methods giving consistently higher data values
  ggplot(aes(x = date, y = rates_AFDW, group = date, fill = rate_name_AFDW)) +
  facet_grid(rows = vars(rate_name_AFDW)) +
  geom_boxplot() +
  scale_fill_viridis_d() +
  labs(x = "", y = expression(Metabolic~Rate~(mgO[2]~day^{-1}~gAFDW^{-1}))) +
  theme_bw() +
  theme(legend.position = "None")


metab_trend_AFDW


# simplified plot for plotly
metab_trend_AFDW_plotly <- dat_long %>%
  filter(exp_ID == 3 & temp_C ==7 | exp_ID == 5 & temp_C == 14.5 | exp_ID == 6 & temp_C == 19.5 | exp_ID == 7 & temp_C == 15 | exp_ID == 8 & temp_C == 9.5 | exp_ID == 9 & temp_C == 6) %>% # filtering only ambient and in-situ temperature data from all experiments except march one due to different biomass methods giving consistently higher data values
  ggplot(aes(x = date, y = rates_AFDW, group = date, fill = rate_name_AFDW)) +
  facet_grid(rows = vars(rate_name_AFDW)) +
  geom_boxplot() +
  scale_fill_viridis_d() +
  theme_bw() +
  theme(legend.position = "None")


p <- plotly::ggplotly(metab_trend_AFDW_plotly)
p


```

### SA normalized
```{r}
metab_trend_sa <- dat_long_m2 %>%
  filter(exp_ID == 3 & temp_C ==7 | exp_ID == 5 & temp_C == 14.5 | exp_ID == 6 & temp_C == 19.5 | exp_ID == 7 & temp_C == 15 | exp_ID == 8 & temp_C == 9.5 | exp_ID == 9 & temp_C == 6) %>% # filtering only ambient and in-situ temperature data from all experiments except march one due to different biomass methods giving consistenly higher data values
  ggplot(aes(x = date, y = rates_m2, group = date, fill = rate_name_m2)) +
  facet_grid(rows = vars(rate_name_m2)) +
  geom_boxplot() +
  scale_fill_viridis_d() +
  labs(x = "", y = expression(Metabolic~Rate~(mgO[2]~day^{-1}~m^{-2})), fill = "Metabolic Rate") +
  theme_bw()


metab_trend_sa


# simplified plot for plotly

metab_trend_sa_plotly <- dat_long_m2 %>%
  filter(exp_ID == 3 & temp_C ==7 | exp_ID == 5 & temp_C == 14.5 | exp_ID == 6 & temp_C == 19.5 | exp_ID == 7 & temp_C == 15 | exp_ID == 8 & temp_C == 9.5 | exp_ID == 9 & temp_C == 6) %>% # filtering only ambient and in-situ temperature data from all experiments except march one due to different biomass methods giving consistenly higher data values
  ggplot(aes(x = date, y = rates_m2, group = date, fill = rate_name_m2)) +
  facet_grid(rows = vars(rate_name_m2)) +
  geom_boxplot() +
  scale_fill_viridis_d() +
  theme_bw()
 
p <- plotly::ggplotly(metab_trend_sa_plotly)
p
```

### combining AFDW and SA metabolic trend plots
```{r}
metab_trend <- (metab_trend_AFDW + metab_trend_sa)

ggsave("plots/main_analysis/metab_trends.png", plot = metab_trend, height = 6, width = 12, dpi = 300)

```


# Models using new AFDW-normalized metab rates and only for repeated-measured experiments

### GPP
```{r}
# making new dataset for lme models to remove NAs and data from april 2021 experiments
dat_lme <- dat_clean %>%
  filter(!is.na(GPP_mgO2_d_gAFDW_2) & exp_ID > 4)

# converting experiment ID, nutrient_trt, and month from numeric to a factor so that they are coded as such in the model instead of as a character
dat_lme$exp_ID <- as.factor(dat_lme$exp_ID)
dat_lme$nutrient_trt <- as.factor(dat_lme$nutrient_trt)
dat_lme$month <- as.factor(dat_lme$month)

# reordering month variable so it graphs months in order
dat_lme$month <- factor(dat_lme$month, levels = c("february", "june", "august", "october", "november"))
levels(dat_lme$month)

# reordering nutrient trt variable so that enriched is first; this guarantees that the nutrient trt effect reported in the model summary reflects the effect of the enriched treatment rather than the ambient treatment
dat_lme$nutrient_trt <- factor(dat_lme$nutrient_trt, levels = c("enriched", "ambient"))

#glimpse(dat_lme)
#View(dat_lme)

m0 <- gls(log(GPP_mgO2_d_gAFDW_2) ~ 1, data = dat_lme)
# starting with as many explanatory variables as possible in the fixed effects component of the models (temp, nutrients, their interaction, and autotrophic index (AI))

m1 <- gls(log(GPP_mgO2_d_gAFDW_2) ~ temp_C * nutrients + AI + exp_ID, method = "REML", data = dat_lme)

m2 <- lme(log(GPP_mgO2_d_gAFDW_2) ~ temp_C * nutrients + AI + exp_ID, random = ~ 1 | rock_ID, data = dat_lme) # adding in random intercept for each rock sample

m3 <- lme(log(GPP_mgO2_d_gAFDW_2) ~ temp_C * nutrients + AI + exp_ID, random = ~ 1 | rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme) # incorporating weights to account for heteroscedasticity within and btwn different experiments

m4 <- lme(log(GPP_mgO2_d_gAFDW_2) ~ temp_C * nutrients + AI + exp_ID, random = ~ 1 + temp_C | rock_ID, data = dat_lme, control=(msMaxIter=500)) # adding in random intercept and slope for each rock sample, also increasing the number of iterations to acheive model convergence


m5 <- lme(log(GPP_mgO2_d_gAFDW_2) ~ temp_C * nutrient_trt*exp_ID + AI, random = ~ 1 + temp_C | rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme, control=(msMaxIter=1000), contrasts = list(exp_ID = contr.sum, nutrient_trt = contr.sum)) # incorporating weights to account for heteroscedasticity within and btwn different experiments, also increasing the number of iterations to acheive model convergence
# including exp_ID as a fixed effect (interested in interpreting seasonal effects and interactions with temp and nutrient effects)
# coded in nutrient_trt as a factor instead of nutrients which is of class numeric
# used contrasts for exp_ID and nutrient_trt so that the coefficients were interpretable as the average of that effect over all the other variable combinations instead of in relation to the first default factor setting (ambient nutrients or the first exp_ID in the data set). This change got rid of covariance structure between temp_C and exp_ID in the model and made interpretations of the coefficients more intuitive.


m10 <- lme(log(GPP_mgO2_d_gAFDW_2) ~ temp_C * nutrient_trt*month + AI, random = ~ 1 + temp_C | rock_ID, weights = varIdent(form = ~1|month), data = dat_lme, control=(msMaxIter=1000), contrasts = list(month = contr.sum, nutrient_trt = contr.sum))
# changing exp_ID to month (this works since there are no repeated months in the dataset so the analyses are equivalent). I did this to make model interpretation more intuitive since exp_ID is an arbitrary value and month is more easy to relate to seasonal effects.

m11 <- lme(log(GPP_mgO2_d_gAFDW_2) ~ temp_C * nutrient_trt*month + AI, random = ~ 1 | rock_ID, weights = varIdent(form = ~1|month), data = dat_lme, control=(msMaxIter=1000), contrasts = list(month = contr.sum, nutrient_trt = contr.sum))
# removing random slope for rock_ID in the random effects in order to compare to the model above


m6 <- lme(log(GPP_mgO2_d_gAFDW_2) ~ temp_C * nutrients + AI, random = ~ 1 | exp_ID / rock_ID, data = dat_lme)

m7 <- lme(log(GPP_mgO2_d_gAFDW_2) ~ temp_C * nutrients + AI, random = ~ 1 | exp_ID / rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme)

#m8 <- lme(log(GPP_mgO2_d_gAFDW_2) ~ temp_C * nutrients + AI, random = ~ 1 + temp_C | exp_ID / rock_ID, data = dat_lme, control=(msMaxIter=500))
# does not converge

m9 <- lme(log(GPP_mgO2_d_gAFDW_2) ~ temp_C * nutrients + AI, random = ~ 1 + temp_C | exp_ID / rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme, control=(msMaxIter=1000))
# does not converge

AIC(m0, m1, m2, m3, m4, m5, m6, m7, m9, m10, m11)
# model 5 has the lowest AIC

summary(m0)

summary(m1)

summary(m2)

summary(m3)

summary(m4)

summary(m5)
# the model summary indicates that the average effect of temp across all experiments and nutrient levels is a 4% increase in GPP per degree C, the average effect of ambient nutrients (low concentrations) across all experiments and temperatures is a reduction in GPP by 6% relative to enriched concentrations?? Need to check emmeans tables to see real temp:nutrient interactions as well as seasonal interactions with nutrients (during which seasons are periphyton more sensitive to a pulse of nutrients?).

summary(m6)

summary(m7)

summary(m9)

summary(m10)

# interpreting effect sizes of temp from m10
exp(0.044)
# for every 1C increase in temperature, GPP increases by 4.5% (a factor of 1.045 mgO2 per day per g AFDW).

# interpreting effect size of nutrients for m10
exp(0.056)
# nutrient enrichement increased GPP rates by 5.8%

# comparing model estimates to see if they change drastically with differing model structure
# produces html file showing models and parameter estimates
#tab_model(m1, m2, m3, m4, m5, m6, m7, m9, m10, dv.labels = c("Model1", "Model2", "Model3", "Model4", "Model5", "Model6", "Model7", "Model9", "Model10"),
 # show.ci = FALSE, 
 # p.style = "stars", 
  # transform = NULL)
```

## Formal Model Comparison
```{r}
# making new dataset for lme models to remove NAs and data from april 2021 experiments
dat_lme <- dat_clean %>%
  filter(!is.na(GPP_mgO2_d_gAFDW_2) & exp_ID > 4)

# converting experiment ID, nutrient_trt, and month from numeric to a factor so that they are coded as such in the model instead of as a character
dat_lme$exp_ID <- as.factor(dat_lme$exp_ID)
dat_lme$nutrient_trt <- as.factor(dat_lme$nutrient_trt)
dat_lme$month <- as.factor(dat_lme$month)

# reordering month variable so it graphs months in order
dat_lme$month <- factor(dat_lme$month, levels = c("february", "june", "august", "october", "november"))
levels(dat_lme$month)

# reordering nutrient trt variable so that enriched is first; this guarantees that the nutrient trt effect reported in the model summary reflects the effect of the enriched treatment rather than the ambient treatment
dat_lme$nutrient_trt <- factor(dat_lme$nutrient_trt, levels = c("enriched", "ambient"))

#glimpse(dat_lme)
#View(dat_lme)

# intercept- only model
m0 <- gls(log(GPP_mgO2_d_gAFDW_2) ~ 1, data = dat_lme)

# starting with as many explanatory variables as possible in the fixed effects component of the models (temp, nutrients, their interaction, and autotrophic index (AI))

m1 <- gls(log(GPP_mgO2_d_gAFDW_2) ~ temp_C * nutrient_trt * month, method = "REML", data = dat_lme)


m2 <- lme(log(GPP_mgO2_d_gAFDW_2) ~ temp_C * nutrient_trt * month, random = ~ 1 | rock_ID, data = dat_lme, contrasts = list(month = contr.sum, nutrient_trt = contr.sum)) # adding in random intercept for each rock sample

m3 <- lme(log(GPP_mgO2_d_gAFDW_2) ~ temp_C * nutrient_trt * month, random = ~ 1 | rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme, contrasts = list(month = contr.sum, nutrient_trt = contr.sum)) # incorporating weights to account for heteroscedasticity within and btwn different experiments

#m4 <- lme(log(GPP_mgO2_d_gAFDW_2) ~ temp_C * nutrient_trt * month, random = ~ 1 + temp_C | rock_ID, data = dat_lme, control=(msMaxIter=1000), contrasts = list(month = contr.sum, nutrient_trt = contr.sum)) # adding in random intercept and slope for each rock sample, also increasing the number of iterations to acheive model convergence
# does not converge


m5 <- lme(log(GPP_mgO2_d_gAFDW_2) ~ temp_C * nutrient_trt * month, random = ~ 1 + temp_C | rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme, control=(msMaxIter=1000), contrasts = list(month = contr.sum, nutrient_trt = contr.sum)) # incorporating weights to account for heteroscedasticity within and btwn different experiments, also increasing the number of iterations to acheive model convergence
# including month as a fixed effect (interested in interpreting seasonal effects and interactions with temp and nutrient effects)
# coded in nutrient_trt as a factor instead of nutrients which is of class numeric
# used contrasts for month and nutrient_trt so that the coefficients were interpretable as the average of that effect over all the other variable combinations instead of in relation to the first default factor setting (ambient nutrients or the first month in the data set). This change got rid of covariance structure between temp_C and month in the model and made interpretations of the coefficients more intuitive.

summary(m5)

# comparing AICs of models
AIC(m0, m1, m2, m3, m5)

GPP_final <- m5
summary(GPP_final)

# summary table for model comparison
tab_model(m0, m1, m2, m3, m5, dv.labels = c("Intercept only", "GLS", "LMM1", "LMM2", "LMM3"),
  show.ci = FALSE,
  show.aic = T,
  p.style = "stars",
  transform = NULL,
  file = "plots/main_analysis/GPP_mod_sum.doc")
```



#### Model validation
```{r}

# diagnostic plots for model with month included as fixed effect for comparison of residuals
# checking ordinary residuals of the final model (these are allowed to show heteroscedasticity). Using code from Zuur et al.
E3 <- resid(GPP_final)
coplot(E3 ∼ rock_ID|month,
ylab = "Ordinary residuals", data = dat_lme)

# now checking standardized residuals of each of the experiments (random effect in the model). These should not show any patterns and should exhibit homogeneous variance.
E4 <- resid(GPP_final, type = "normalized")
coplot(E4 ∼ rock_ID|month,
ylab = "Normalized residuals", data = dat_lme)

plot(GPP_final)


```


#### emmeans & emmip: Visualizing model interactions
```{r}
# reccommended emmeans analyses from Stats Consulting

#emmeans(m5, pairwise ~ nutrient_trt|exp_ID, cov.keep = "temp_C")

#emmeans(m5, pairwise ~ exp_ID, cov.keep = "temp_C")

#emmip(m5, nutrient_trt ~ temp_C|exp_ID, CIs = T, cov.keep = c("temp_C", "nutrient_trt")) +
 # geom_point(aes(x = temp_C, y = log(GPP_mgO2_d_gAFDW_2), color = nutrient_trt), data = dat_lme)



# same interaction analysis for m10 (has month instead of exp_ID in model)

nut_seasonal <- emmeans(GPP_final, pairwise ~ nutrient_trt|month, cov.keep = "temp_C", type = "response")
# shows seasonal interactions with nutrient enrichment; nutrients seemed to have a signficant effect on october incubations suggesting that periphyton are sensitive to nutrient additions at this timepoint

nut_seasonal <- nut_seasonal$contrasts %>%
  as.data.frame() %>% # saving emmeans contrasts as a dataframe so I can export results in a table
  mutate(across(c(ratio:p.value), ~signif(.,4))) # rounding numbers in all numeric columns to 4 sig figs

# printing table of data
table <- nut_seasonal %>%
    gt() %>%
  cols_label(contrast = "comparison", ratio = "effect size") %>%
  tab_header(title = "Seasonal Variation in Nutrient Effects on Periphyton GPP")
gtsave("plots/main_analysis/nut_seasonal_GPP.png", data = table)



#######################################

emmeans(GPP_final, pairwise ~ month, cov.keep = "temp_C", type = "response")
# shows effect of month on GPP averaged across all levels of temperature and nutrients, with direct pairwise comparisions between months.



############################
temp_seasonal <- emtrends(GPP_final, pairwise ~ month, var = "temp_C")
# shows the interaction between month and temperature, with the difference slopes of temperature shown for each month

temp_seasonal <- temp_seasonal$contrasts %>%
  as.data.frame() # saving emtrends contrasts as a dataframe so I can export results in a table

# printing table of data
temp_table <- temp_seasonal %>%
    gt() %>%
  tab_header(title = "Seasonal Variation in Temperature Effects on Periphyton GPP")
gtsave("plots/main_analysis/temp_seasonal_GPP.png", data = temp_table)


# now making a table of the emmeans instead of the contrasts for the same emtrends results

temp_seasonal_emm <- emtrends(GPP_final, pairwise ~ month, var = "temp_C")

temp_seasonal_emm <- temp_seasonal_emm$emtrends %>%
  as.data.frame() # saving emtrends contrasts as a dataframe so I can export results in a table
  

# printing table of data and calculating Q10 values from temperature coefficients (done by raising them to the 10th power)
temp_emmeans_table <- temp_seasonal_emm %>%
  mutate(temp_C.trend = exp(temp_C.trend)) %>% # putting the estimated temp trends in the response scale by undoing the log-transformation
  mutate(Q10_value = temp_C.trend^10) %>% # calculating Q10 values
  mutate(across(c(temp_C.trend:Q10_value), ~round(.,4))) %>% # rounding all numeric columns to 4 sig figs
    gt() %>%
  cols_move(columns = Q10_value, after = temp_C.trend) %>%
  cols_label(temp_C.trend = "temperature effect", Q10_value = html("Q<sub>10</sub> ")) %>%
  tab_header(title = "Seasonal Variation in Temperature Effects on Periphyton GPP")
gtsave("plots/main_analysis/temp_seasonal_GPP_emmeans.png", data = temp_emmeans_table)



############################
temp_nut_seasonal <- emtrends(GPP_final, pairwise ~ nutrient_trt | month, var = "temp_C")
# shows interaction between temperature and nutrients for each month

temp_nut_seasonal <- temp_nut_seasonal$contrasts %>%
  as.data.frame()

# printing table of data
temp_nut_table <- temp_nut_seasonal %>%
    gt() %>%
  tab_header(title = "Seasonal Variation in Temperature-Nutrient Interactions on Periphyton GPP")
gtsave("plots/main_analysis/temp_nut_seasonal_GPP.png", data = temp_nut_table)


# interaction plot of temp, nutrients, and month in log scale
GPP_IP <- emmip(GPP_final, nutrient_trt ~ temp_C|month, CIs = T, cov.keep = c("temp_C", "nutrient_trt")) +
  geom_point(aes(x = temp_C, y = log(GPP_mgO2_d_gAFDW_2), color = nutrient_trt), data = dat_lme) +
  facet_grid(cols = vars(month)) +
  labs(y = expression(log(GPP~(mgO[2]~day^{-1}~gAFDW^{-1}))), x = "") +
  theme_minimal() +
  theme(legend.position = "none")

ggsave("plots/main_analysis/GPP_IP.png", plot = GPP_IP, width = 7, height = 3, dpi = 300)

# interaction plot of temp, nutrients, and month in response scale
emmip(GPP_final, nutrient_trt ~ temp_C|month, CIs = T, cov.keep = c("temp_C", "nutrient_trt"), type = "response") +
  geom_point(aes(x = temp_C, y = GPP_mgO2_d_gAFDW_2, color = nutrient_trt), data = dat_lme) +
  theme_minimal()

```


### ER
```{r}
# making new dataset for lme models to remove NAs and data from april 2021 experiments
dat_lme <- dat_clean %>%
  filter(!is.na(ER_mgO2_d_gAFDW_2) & exp_ID > 4)

# converting experiment ID, nutrient_trt, and month from numeric to a factor
dat_lme$exp_ID <- as.factor(dat_lme$exp_ID)
dat_lme$nutrient_trt <- as.factor(dat_lme$nutrient_trt)
dat_lme$month <- as.factor(dat_lme$month)


# reordering month variable so it graphs months in order
dat_lme$month <- factor(dat_lme$month, levels = c("february", "june", "august", "october", "november"))

# reordering nutrient trt variable so that enriched is first; this guarantees that the nutrient trt effect reported in the model summary reflects the effect of the enriched treatment rather than the ambient treatment
dat_lme$nutrient_trt <- factor(dat_lme$nutrient_trt, levels = c("enriched", "ambient"))

#glimpse(dat_lme)
#View(dat_lme)
# intercept-only model as a baseline
m0 <- gls(log(ER_mgO2_d_gAFDW_2) ~ 1, data = dat_lme)

# starting with as many explanatory variables as possible in the fixed component of the models (temp, nutrients, and their interaction)
m1 <- gls(log(ER_mgO2_d_gAFDW_2) ~ temp_C * nutrients + AI + exp_ID, method = "REML", data = dat_lme)

m2 <- lme(log(ER_mgO2_d_gAFDW_2) ~ temp_C * nutrients + AI + exp_ID, random = ~ 1 | rock_ID, data = dat_lme) # adding in random intercept for each rock sample

m3 <- lme(log(ER_mgO2_d_gAFDW_2) ~ temp_C * nutrients + AI + exp_ID, random = ~ 1 | rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme)

m4 <- lme(log(ER_mgO2_d_gAFDW_2) ~ temp_C * nutrients + AI + exp_ID, random = ~ 1 + temp_C | rock_ID, data = dat_lme) # adding random intercept for rock and random slope for temperature


#m5 <- lme(log(ER_mgO2_d_gAFDW_2) ~ temp_C * nutrients + AI + exp_ID, random = ~ 1 + temp_C | rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme)
# does not converge

# adding exp_ID as a random effect instead of a fixed effect

m6 <- lme(log(ER_mgO2_d_gAFDW_2) ~ temp_C * nutrients + AI, random = ~ 1 | exp_ID / rock_ID, data = dat_lme)

m7 <- lme(log(ER_mgO2_d_gAFDW_2) ~ temp_C * nutrients + AI, random = ~ 1 | exp_ID / rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme)

#m8 <- lme(log(ER_mgO2_d_gAFDW_2) ~ temp_C * nutrients + AI, random = ~ 1 + temp_C | exp_ID / rock_ID, data = dat_lme)
# does not converge

#m9 <- lme(log(ER_mgO2_d_gAFDW_2) ~ temp_C * nutrients + AI, random = ~ 1 + temp_C | exp_ID / rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme)
# does not converge

m10 <- lme(log(ER_mgO2_d_gAFDW_2) ~ temp_C * nutrient_trt*month + AI, random = ~ 1 | rock_ID, weights = varIdent(form = ~1|month), data = dat_lme, control=(msMaxIter=1000), contrasts = list(month = contr.sum, nutrient_trt = contr.sum)) # incorporating weights to account for heteroscedasticity within and btwn different experiments, also increasing the number of iterations to acheive model convergence
# including exp_ID as a fixed effect (interested in interpreting seasonal effects and interactions with temp and nutrient effects)
# coded in nutrient_trt as a factor instead of nutrients which is of class numeric
# used contrasts for month and nutrient_trt so that the coefficients were interpretable as the average of that effect over all the other variable combinations instead of in relation to the first default factor setting (ambient nutrients or the first month in the data set). This change got rid of covariance structure between temp_C and exp_ID in the model and made interpretations of the coefficients more intuitive.

#m11 <- lme(log(ER_mgO2_d_gAFDW_2) ~ temp_C * nutrient_trt*month + AI, random = ~ 1 + temp_C | rock_ID, weights = varIdent(form = ~1|month), data = dat_lme, control=(msMaxIter=1000), contrasts = list(month = contr.sum, nutrient_trt = contr.sum))
# added random slope for rock_ID, but the model does not converge

AIC(m0, m1, m2, m3, m4, m6, m7, m10)
# model 7 has the strongest support according to AIC

summary(m0)

summary(m3)
# looks like all the fixed effects are statistically significant and will be kept in the model

summary(m7)

summary(m10)

# both models 3 and 7 have the structure I need, but including exp_ID (experiment ID) as a random effect is more accurate to the experiment structure since seasonality is nested within the temp:nutrient effects and we expect a distribution of effect estimates across seasons rather than one "true" temp and nutrient effect for all seasons.


# interpreting effect size of temp in m10
exp(0.068)

# for every 1C increase in temperature, ER increases by 7% (a factor of 1.070 mg O2 per day per g AFDW)

# interpreting effect size of nutrients
exp(0.22)

# enriched ER rates were increased by 59% on average relative to ambient rates

# interpreting temp:nutrient interaction effect
1-exp(-.0153)

# when nutrients are enriched, the rate of increase of metabolic rate for every degree celsius decreases by 1.5%.



# comparing model estimates to see if they change drastically with differing model structure
# produces html file showing models and parameter estimates

# making summary table with models
#tab_model(m1, m2, m3, m4, m6, m7, m10, dv.labels = c("Model1", "Model2", "Model3", "Model4", "Model6", "Model7", "Model10"),
 #show.ci = FALSE, 
  #p.style = "stars", 
  #transform = NULL)
```


## Formal Model Comparison
```{r}
# making new dataset for lme models to remove NAs and data from april 2021 experiments
dat_lme <- dat_clean %>%
  filter(!is.na(ER_mgO2_d_gAFDW_2) & exp_ID > 4)

# converting experiment ID, nutrient_trt, and month from numeric to a factor so that they are coded as such in the model instead of as a character
dat_lme$exp_ID <- as.factor(dat_lme$exp_ID)
dat_lme$nutrient_trt <- as.factor(dat_lme$nutrient_trt)
dat_lme$month <- as.factor(dat_lme$month)

# reordering month variable so it graphs months in order
dat_lme$month <- factor(dat_lme$month, levels = c("february", "june", "august", "october", "november"))
levels(dat_lme$month)

# reordering nutrient trt variable so that enriched is first; this guarantees that the nutrient trt effect reported in the model summary reflects the effect of the enriched treatment rather than the ambient treatment
dat_lme$nutrient_trt <- factor(dat_lme$nutrient_trt, levels = c("enriched", "ambient"))

#glimpse(dat_lme)
#View(dat_lme)

# intercept- only model
m0 <- gls(log(ER_mgO2_d_gAFDW_2) ~ 1, data = dat_lme)

# starting with as many explanatory variables as possible in the fixed effects component of the models (temp, nutrients, their interaction, and autotrophic index (AI))

m1 <- gls(log(ER_mgO2_d_gAFDW_2) ~ temp_C * nutrient_trt * month, method = "REML", data = dat_lme)

m2 <- lme(log(ER_mgO2_d_gAFDW_2) ~ temp_C * nutrient_trt * month, random = ~ 1 | rock_ID, data = dat_lme, contrasts = list(month = contr.sum, nutrient_trt = contr.sum)) # adding in random intercept for each rock sample

m3 <- lme(log(ER_mgO2_d_gAFDW_2) ~ temp_C * nutrient_trt * month, random = ~ 1 | rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme, contrasts = list(month = contr.sum, nutrient_trt = contr.sum)) # incorporating weights to account for heteroscedasticity within and btwn different experiments

#m4 <- lme(log(ER_mgO2_d_gAFDW_2) ~ temp_C * nutrient_trt * month, random = ~ 1 + temp_C | rock_ID, data = dat_lme, control=(msMaxIter=1000), contrasts = list(month = contr.sum, nutrient_trt = contr.sum)) # adding in random intercept and slope for each rock sample, also increasing the number of iterations to acheive model convergence
# does not converge



#m5 <- lme(log(ER_mgO2_d_gAFDW_2) ~ temp_C * nutrient_trt * month, random = ~ 1 + temp_C | rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme, control=(msMaxIter=1000), contrasts = list(month = contr.sum, nutrient_trt = contr.sum)) 
# does not converge
# incorporating weights to account for heteroscedasticity within and btwn different experiments, also increasing the number of iterations to acheive model convergence
# including month as a fixed effect (interested in interpreting seasonal effects and interactions with temp and nutrient effects)
# coded in nutrient_trt as a factor instead of nutrients which is of class numeric
# used contrasts for month and nutrient_trt so that the coefficients were interpretable as the average of that effect over all the other variable combinations instead of in relation to the first default factor setting (ambient nutrients or the first month in the data set). This change got rid of covariance structure between temp_C and month in the model and made interpretations of the coefficients more intuitive.

summary(m3)

# comparing AICs of models
AIC(m0, m1, m2, m3)

ER_final <- m3
summary(ER_final)

# summary table for model comparison
tab_model(m0, m1, m2, m3, dv.labels = c("Intercept only", "GLS", "LMM1", "LMM2"),
  show.ci = FALSE,
  show.aic = T,
  p.style = "stars",
  transform = NULL,
  file = "plots/main_analysis/ER_mod_sum.doc")
```


#### Model validation
```{r}
# checking ordinary residuals of the final model (these are allowed to show heteroscedasticity). Using code from Zuur et al.
E1 <- resid(ER_final)
coplot(E1 ∼ rock_ID|month,
ylab = "Ordinary residuals", data = dat_lme)

# now checking standardized residuals of each of the experiments (random effect in the model). These should not show any patterns and should exhibit homogeneous variance.
E2 <- resid(ER_final, type = "normalized")
coplot(E2 ∼ rock_ID|month,
ylab = "Normalized residuals", data = dat_lme)

#coplot(resid(m10) ~ fitted(m10) | dat_lme$exp_ID)

plot(ER_final)





```


#### emmeans and emmip: Visualizing model interactions
```{r}
#emtrends(m7, pairwise ~ nutrients, var = "temp_C")

#emmip(m7, nutrients ~ temp_C, cov.reduce = F, CIs = T) +
  #geom_point(aes(x = temp_C, y = log(ER_mgO2_d_gAFDW_2), color = interaction(temp_C, nutrients)), data = dat_lme)


# plots to interpret model 10
nut_seasonal_ER <- emmeans(ER_final, pairwise ~ nutrient_trt|month, cov.keep = "temp_C", type = "response")
# shows seasonal interactions with nutrient enrichment; nutrients seemed to have a signficant effect on october incubations suggesting that periphyton are sensitive to nutrient additions at this timepoint

nut_seasonal_ER <- nut_seasonal_ER$contrasts %>%
  as.data.frame() %>% # saving contrasts from emmeans as dataframe so I can export a table of the results
  mutate(across(c(ratio:p.value), ~signif(.,4))) # rounding numbers in all numeric columns to 4 sig figs

# printing table of data
nut_table_ER <- nut_seasonal_ER %>%
    gt() %>%
  cols_label(contrast = "comparison", ratio = "effect size") %>%
  tab_header(title = "Seasonal Variation in Nutrient Effects on Periphyton ER")
gtsave("plots/main_analysis/nut_seasonal_ER.png", data = nut_table_ER)



####################
emmeans(ER_final, pairwise ~ month, cov.keep = "temp_C", type = "response")
# shows effect of month on ER averaged across all levels of temperature and nutrients, with direct pairwise comparisions between months.


######################
temp_seasonal_ER <- emtrends(ER_final, pairwise ~ month , var = "temp_C" )
# shows the interaction between month and temperature, with the difference slopes of temperature shown for each month

temp_seasonal_ER <- temp_seasonal_ER$contrasts %>%
  as.data.frame() # saving contrasts from emmeans as dataframe so I can export a table of the results

temp_table_ER <- temp_seasonal_ER %>%
  gt() %>%
  tab_header(title = "Seasonal Variation in Temperature Effects on Periphyton ER")
gtsave("plots/main_analysis/temp_seasonal_ER.png", data = temp_table_ER)

# now making a table of the emmeans instead of the contrasts for the same emtrends results

temp_seasonal_ER_emm <- emtrends(ER_final, pairwise ~ month, var = "temp_C")

temp_seasonal_ER_emm <- temp_seasonal_ER_emm$emtrends %>%
  as.data.frame() # saving emtrends contrasts as a dataframe so I can export results in a table

# printing table of data with associated Q10 values
temp_emmeans_table_ER <- temp_seasonal_ER_emm %>%
  mutate(temp_C.trend = exp(temp_C.trend)) %>% # putting the estimated temp trends in the response scale by undoing the log-transformation
   mutate(Q10_value = temp_C.trend^10) %>% # calculating Q10 values
   mutate(across(c(temp_C.trend:Q10_value), ~round(.,4))) %>% # rounding all numeric columns to 4 sig figs
    gt() %>%
  cols_move(columns = Q10_value, after = temp_C.trend) %>%
  cols_label(temp_C.trend = "temperature effect", Q10_value = html("Q<sub>10</sub> ")) %>%
  tab_header(title = "Seasonal Variation in Temperature Effects on Periphyton ER")
gtsave("plots/main_analysis/temp_seasonal_ER_emmeans.png", data = temp_emmeans_table_ER)



##################
temp_nut_seasonal_ER <- emtrends(ER_final, pairwise ~ nutrient_trt | month, var = "temp_C") # checking out temperature-nutrient interactions for each month

temp_nut_seasonal_ER <- temp_nut_seasonal_ER$contrasts %>%
  as.data.frame()# saving contrasts from emmeans as dataframe so I can export a table of the results

temp_nut_table_ER <- temp_nut_seasonal_ER %>%
  gt() %>%
  tab_header(title = "Seasonal Variation in Temperature-Nutrient Interactions on Periphyton ER")
gtsave("plots/main_analysis/temp_nut_seasonal_ER.png", data = temp_nut_table_ER)


################

# interaction plot of temp, nutrients, and month in log scale
ER_IP <- emmip(ER_final, nutrient_trt ~ temp_C|month, CIs = T, cov.keep = c("temp_C", "nutrient_trt")) +
  geom_point(aes(x = temp_C, y = log(ER_mgO2_d_gAFDW_2), color = nutrient_trt), data = dat_lme) +
  facet_grid(cols = vars(month)) +
  labs(y = expression(log(ER~(mgO[2]~day^{-1}~gAFDW^{-1}))), x = "") +
  theme_minimal() +
  theme(legend.position = "none")

ggsave("plots/main_analysis/ER_IP.png", plot = ER_IP, width = 7, height = 3, dpi = 300)

# interaction plot of temp, nutrients, and month in response scale
emmip(ER_final, nutrient_trt ~ temp_C|month, CIs = T, cov.keep = c("temp_C", "nutrient_trt"), type = "response") +
  geom_point(aes(x = temp_C, y = ER_mgO2_d_gAFDW_2, color = nutrient_trt), data = dat_lme) +
  theme_minimal()
```


### NEP
```{r}
# making new dataset for lme models to remove NAs and data from april 2021 experiments
dat_lme <- dat_clean %>%
  filter(!is.na(NEP_mgO2_d_gAFDW_2) & exp_ID > 4)

# converting experiment ID from numberic to a factor
dat_lme$exp_ID <- as.factor(dat_lme$exp_ID)
dat_lme$nutrient_trt <- as.factor(dat_lme$nutrient_trt)
dat_lme$month <- as.factor(dat_lme$month)

# reordering month variable so it graphs months in order
dat_lme$month <- factor(dat_lme$month, levels = c("february", "june", "august", "october", "november"))

# reordering nutrient trt variable so that enriched is first; this guarantees that the nutrient trt effect reported in the model summary reflects the effect of the enriched treatment rather than the ambient treatment
dat_lme$nutrient_trt <- factor(dat_lme$nutrient_trt, levels = c("enriched", "ambient"))

#glimpse(dat_lme)
#View(dat_lme)

# intercept-only model
m0 <- gls(log(NEP_mgO2_d_gAFDW_2) ~ 1, data = dat_lme)

# starting with as many explanatory variables as possible in the fixed component of the models (temp, nutrients, and their interaction)
m1 <- gls(log(NEP_mgO2_d_gAFDW_2) ~ temp_C * nutrients + AI + exp_ID, method = "REML", data = dat_lme)

m2 <-  lme(log(NEP_mgO2_d_gAFDW_2) ~ temp_C * nutrients + AI + exp_ID, random = ~ 1 | rock_ID, data = dat_lme) # adding random intercept for each rock

m3 <- lme(log(NEP_mgO2_d_gAFDW_2) ~ temp_C * nutrients + AI + exp_ID, random = ~ 1 | rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme) # accounting for heteroscedasticity within and among different experiments

m4 <- lme(log(NEP_mgO2_d_gAFDW_2) ~ temp_C * nutrients + AI + exp_ID, random = ~ 1 + temp_C| rock_ID, data = dat_lme, control=(msMaxIter=500)) # adding random slopes for each rock (i.e. the relationship between temperature and NEP varies for each individual rock)
# model does not converge

m5 <- lme(log(NEP_mgO2_d_gAFDW_2) ~ temp_C * nutrients + AI + exp_ID, random = ~ 1 + temp_C| rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme, control=(msMaxIter=500)) # now adding in variance structure back in to account for heterscedasticity within and between experiments
# model does not converge

# adding exp_ID as a random effect instead of a fixed effect

m6 <- lme(log(NEP_mgO2_d_gAFDW_2) ~ temp_C * nutrients + AI, random = ~ 1 | exp_ID / rock_ID, data = dat_lme)

m7 <- lme(log(NEP_mgO2_d_gAFDW_2) ~ temp_C * nutrients + AI, random = ~ 1 | exp_ID / rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme)

m8 <- lme(log(NEP_mgO2_d_gAFDW_2) ~ temp_C * nutrients + AI, random = ~ 1 + temp_C| exp_ID / rock_ID, data = dat_lme, control=(msMaxIter=500))

m9 <- lme(log(NEP_mgO2_d_gAFDW_2) ~ temp_C * nutrients + AI, random = ~ 1 + temp_C| exp_ID / rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme, control=(msMaxIter=500))

m10 <- lme(log(NEP_mgO2_d_gAFDW_2) ~ temp_C * nutrient_trt*month + AI, random = ~ 1 + temp_C | rock_ID, weights = varIdent(form = ~1|month), data = dat_lme, control=(msMaxIter=1000), contrasts = list(month = contr.sum, nutrient_trt = contr.sum)) # incorporating weights to account for heteroscedasticity within and btwn different experiments, also increasing the number of iterations to acheive model convergence
# including exp_ID as a fixed effect (interested in interpreting seasonal effects and interactions with temp and nutrient effects)
# coded in nutrient_trt as a factor instead of nutrients which is of class numeric
# used contrasts for month and nutrient_trt so that the coefficients were interpretable as the average of that effect over all the other variable combinations instead of in relation to the first default factor setting (ambient nutrients or the first month in the data set). This change got rid of covariance structure between temp_C and exp_ID in the model and made interpretations of the coefficients more intuitive.


m11 <- lme(log(NEP_mgO2_d_gAFDW_2) ~ temp_C * nutrient_trt*month + AI, random = ~ 1 | rock_ID, weights = varIdent(form = ~1|month), data = dat_lme, control=(msMaxIter=1000), contrasts = list(month = contr.sum, nutrient_trt = contr.sum))
# removing random slope from rock_ID to compare to the model above

AIC(m0, m1, m2, m3, m4, m5, m6, m7, m8, m9, m10, m11)
# model 9 has the most support according to AIC

summary(m0)

summary(m5)

summary(m6)

summary(m7)

summary(m8)

summary(m9)

summary(m10)



# interpreting effect size of temp in m5
exp(0.041)

# for every 1C increase in temperature, NEP increases by 4.2% (a factor of 1.042 mg O2 per day per g AFDW)

# interpreting temp effect size in m10
exp(0.035)

# for every 1C increase in temperature, NEP increases by 3.6% (a factor of 1.036 mg O2 per day per g AFDW)

# interpreting nutrient effect size in m10
exp(0.011)


# comparing model estimates to see if they change drastically with differing model structure
# produces html file showing models and parameter estimates

# summary table for model estimates
#tab_model(m1, m2, m3, m4, m5, m6, m7, m8, m9, m10, dv.labels = c("Model1", "Model2", "Model3", "Model4", "Model5", "Model6", "Model7", "Model8", "Model9", "Model10"),
  #show.ci = FALSE, 
  #p.style = "stars", 
  #transform = NULL)
```


## Formal Model Comparison
```{r}
# making new dataset for lme models to remove NAs and data from april 2021 experiments
dat_lme <- dat_clean %>%
  filter(!is.na(NEP_mgO2_d_gAFDW_2) & exp_ID > 4)

# converting experiment ID, nutrient_trt, and month from numeric to a factor so that they are coded as such in the model instead of as a character
dat_lme$exp_ID <- as.factor(dat_lme$exp_ID)
dat_lme$nutrient_trt <- as.factor(dat_lme$nutrient_trt)
dat_lme$month <- as.factor(dat_lme$month)

# reordering month variable so it graphs months in order
dat_lme$month <- factor(dat_lme$month, levels = c("february", "june", "august", "october", "november"))
levels(dat_lme$month)

# reordering nutrient trt variable so that enriched is first; this guarantees that the nutrient trt effect reported in the model summary reflects the effect of the enriched treatment rather than the ambient treatment
dat_lme$nutrient_trt <- factor(dat_lme$nutrient_trt, levels = c("enriched", "ambient"))

#glimpse(dat_lme)
#View(dat_lme)

# intercept- only model
m0 <- gls(log(NEP_mgO2_d_gAFDW_2) ~ 1, data = dat_lme)

# starting with as many explanatory variables as possible in the fixed effects component of the models (temp, nutrients, their interaction, and autotrophic index (AI))

m1 <- gls(log(NEP_mgO2_d_gAFDW_2) ~ temp_C * nutrient_trt * month, method = "REML", data = dat_lme)

m2 <- lme(log(NEP_mgO2_d_gAFDW_2) ~ temp_C * nutrient_trt * month, random = ~ 1 | rock_ID, data = dat_lme, contrasts = list(month = contr.sum, nutrient_trt = contr.sum)) # adding in random intercept for each rock sample

m3 <- lme(log(NEP_mgO2_d_gAFDW_2) ~ temp_C * nutrient_trt * month, random = ~ 1 | rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme, contrasts = list(month = contr.sum, nutrient_trt = contr.sum)) # incorporating weights to account for heteroscedasticity within and btwn different experiments

m4 <- lme(log(NEP_mgO2_d_gAFDW_2) ~ temp_C * nutrient_trt * month, random = ~ 1 + temp_C | rock_ID, data = dat_lme, control=(msMaxIter=1000), contrasts = list(month = contr.sum, nutrient_trt = contr.sum)) # adding in random intercept and slope for each rock sample, also increasing the number of iterations to acheive model convergence
# does not converge


m5 <- lme(log(NEP_mgO2_d_gAFDW_2) ~ temp_C * nutrient_trt * month, random = ~ 1 + temp_C | rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme, control=(msMaxIter=1000), contrasts = list(month = contr.sum, nutrient_trt = contr.sum)) # incorporating weights to account for heteroscedasticity within and btwn different experiments, also increasing the number of iterations to acheive model convergence
# including month as a fixed effect (interested in interpreting seasonal effects and interactions with temp and nutrient effects)
# coded in nutrient_trt as a factor instead of nutrients which is of class numeric
# used contrasts for month and nutrient_trt so that the coefficients were interpretable as the average of that effect over all the other variable combinations instead of in relation to the first default factor setting (ambient nutrients or the first month in the data set). This change got rid of covariance structure between temp_C and month in the model and made interpretations of the coefficients more intuitive.

# comparing AICs of models
AIC(m0, m1, m2, m3, m4, m5)

summary(m5)
NEP_final <- m5

summary(NEP_final)

# summary table for model comparison
tab_model(m0, m1, m2, m3, m4, m5, dv.labels = c("Intercept only", "GLS", "LMM1", "LMM2", "LMM3", "LMM4"),
  show.ci = FALSE,
  show.aic = T,
  p.style = "stars",
  transform = NULL,
  file = "plots/main_analysis/NEP_mod_sum.doc")
```


#### Model validation
```{r}
# checking ordinary residuals of the final model (these are allowed to show heteroscedasticity). Using code from Zuur et al.
E1 <- resid(NEP_final)
coplot(E1 ∼ rock_ID|month,
ylab = "Ordinary residuals", data = dat_lme)

# now checking standardized residuals of each of the experiments (random effect in the model). These should not show any patterns and should exhibit homogeneous variance.
E2 <- resid(NEP_final, type = "normalized")
coplot(E2 ∼ rock_ID|month,
ylab = "Normalized residuals", data = dat_lme)

#coplot(resid(m10) ~ fitted(m10) | dat_lme$exp_ID)

plot(NEP_final)



```



#### emmeans and emmip: Visualizing model interactions
```{r}
#emtrends(m9, pairwise ~ nutrients, var = "temp_C")

#emmip(m9, nutrients ~ temp_C, cov.reduce = F, CIs = T) +
 # geom_point(aes(x = temp_C, y = log(NEP_mgO2_d_gAFDW_2), color = interaction(temp_C, nutrients)), data = dat_lme)


####################
nut_seasonal_NEP <- emmeans(NEP_final, pairwise ~ nutrient_trt|month, cov.keep = "temp_C", type = "response")
# shows seasonal interactions with nutrient enrichment; nutrients seemed to have a signficant effect on october incubations suggesting that periphyton are sensitive to nutrient additions at this timepoint

nut_seasonal_NEP <- nut_seasonal_NEP$contrasts %>%
  as.data.frame() %>% # saving contrasts from emmeans as dataframe so I can export a table of the results
  mutate(across(c(ratio:p.value), ~signif(.,4))) # rounding numbers in all numeric columns to 4 sig figs

# printing table of data
nut_table_NEP <- nut_seasonal_NEP %>%
    gt() %>%
  cols_label(contrast = "comparison", ratio = "effect size") %>%
  tab_header(title = "Seasonal Variation in Nutrient Effects on Periphyton NEP")
gtsave("plots/main_analysis/nut_seasonal_NEP.png", data = nut_table_NEP)


#######################
emmeans(NEP_final, pairwise ~ month, cov.keep = "temp_C", type = "response")
# shows effect of month on NEP averaged across all levels of temperature and nutrients, with direct pairwise comparisions between months.




###################
temp_seasonal_NEP <- emtrends(NEP_final, pairwise ~ month , var = "temp_C" )
# shows the interaction between month and temperature, with the difference slopes of temperature shown for each month

temp_seasonal_NEP <- temp_seasonal_NEP$contrasts %>%
  as.data.frame() # saving contrasts from emmeans as dataframe so I can export a table of the results

# printing table of data
temp_table_NEP <- temp_seasonal_NEP %>%
    gt() %>%
  tab_header(title = "Seasonal Variation in Temperature Effects on Periphyton NEP")
gtsave("plots/main_analysis/temp_seasonal_NEP.png", data = temp_table_NEP)


# now making a table of the emmeans instead of the contrasts for the same emtrends results

temp_seasonal_NEP_emm <- emtrends(NEP_final, pairwise ~ month, var = "temp_C")

temp_seasonal_NEP_emm <- temp_seasonal_NEP_emm$emtrends %>%
  as.data.frame() # saving emtrends contrasts as a dataframe so I can export results in a table

# printing table of data with associated Q10 values
temp_emmeans_table_NEP <- temp_seasonal_NEP_emm %>%
  mutate(temp_C.trend = exp(temp_C.trend)) %>% # putting the estimated temp trends in the response scale by undoing the log-transformation
   mutate(Q10_value = temp_C.trend^10) %>% # calculating Q10 values
   mutate(across(c(temp_C.trend:Q10_value), ~round(.,4))) %>% # rounding all numeric columns to 4 sig figs
    gt() %>%
  cols_move(columns = Q10_value, after = temp_C.trend) %>%
  cols_label(temp_C.trend = "temperature effect", Q10_value = html("Q<sub>10</sub> ")) %>%
  tab_header(title = "Seasonal Variation in Temperature Effects on Periphyton NEP")
gtsave("plots/main_analysis/temp_seasonal_NEP_emmeans.png", data = temp_emmeans_table_NEP)


#####################

temp_nut_seasonal_NEP <- emtrends(NEP_final, pairwise ~ nutrient_trt | month, var = "temp_C") # checking out temperature-nutrient interactions for each month

temp_nut_seasonal_NEP <- temp_nut_seasonal_NEP$contrasts %>%
  as.data.frame() # saving contrasts from emmeans as dataframe so I can export a table of the results

# printing table of data
temp_nut_table_NEP <- temp_nut_seasonal_NEP %>%
    gt() %>%
  tab_header(title = "Seasonal Variation in Temperature-Nutrient Interactions on Periphyton NEP")
gtsave("plots/main_analysis/temp_nut_seasonal_NEP.png", data = temp_nut_table_NEP)



#######################

# interaction plot of temp, nutrients, and month in log scale
NEP_IP <- emmip(NEP_final, nutrient_trt ~ temp_C|month, CIs = T, cov.keep = c("temp_C", "nutrient_trt")) +
  geom_point(aes(x = temp_C, y = log(NEP_mgO2_d_gAFDW_2), color = nutrient_trt), data = dat_lme) +
  facet_grid(cols = vars(month)) +
  scale_color_discrete("Nutrient Treatment") +
  labs(y = expression(log(NEP~(mgO[2]~day^{-1}~gAFDW^{-1}))), x = expression('Temperature (\u00B0C)')) +
  theme_minimal() +
   theme(legend.position = "bottom")

ggsave("plots/main_analysis/NEP_IP.png", plot = NEP_IP, width = 7, height = 3, dpi = 300)

# interaction plot of temp, nutrients, and month in response scale
emmip(NEP_final, nutrient_trt ~ temp_C|month, CIs = T, cov.keep = c("temp_C", "nutrient_trt"), type = "response") +
  geom_point(aes(x = temp_C, y = NEP_mgO2_d_gAFDW_2, color = nutrient_trt), data = dat_lme) +
  facet_grid(cols = vars(month)) +
  theme_minimal()
```


### Stacking plots
```{r}
# combining emmip plots for GPP, ER, and NEP
library(patchwork)

metab_IP <- (GPP_IP/ER_IP/ NEP_IP)

ggsave("plots/main_analysis/metab_IP.png", plot = metab_IP, height = 8, width = 7, dpi = 300)
```


### Model Summary Table
```{r}
tab_model(GPP_final, ER_final, NEP_final, dv.labels = c("GPP", "ER", "NEP"),
  show.ci = FALSE, 
  p.style = "stars", 
  transform = "exp",
  file = "plots/main_analysis/mod_sum.doc") # saving model tabel as a doc file, looks great!

```



# Models for surface area normalized rates

## GPP
```{r}
# making new dataset for lme models to remove NAs and data from april 2021 experiments
dat_lme <- dat_clean %>%
  filter(!is.na(GPP_mgO2_d_m2) & exp_ID > 4)

# converting experiment ID from numberic to a factor
dat_lme$exp_ID <- as.factor(dat_lme$exp_ID)

glimpse(dat_lme)
#View(dat_lme)

# starting with as many explanatory variables as possible in the fixed effects component of the models (temp, nutrients, their interaction, and autotrophic index (AI))
m1 <- gls(log(GPP_mgO2_d_m2) ~ temp_C * nutrients + AI + exp_ID, method = "REML", data = dat_lme)

m2 <- lme(log(GPP_mgO2_d_m2) ~ temp_C * nutrients + AI + exp_ID, random = ~ 1 | rock_ID, data = dat_lme) # adding in random intercept for each rock sample

m3 <- lme(log(GPP_mgO2_d_m2) ~ temp_C * nutrients + AI + exp_ID, random = ~ 1 | rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme) # incorporating weights to account for heteroscedasticity within and btwn different experiments

m4 <- lme(log(GPP_mgO2_d_m2) ~ temp_C * nutrients + AI + exp_ID, random = ~ 1 + temp_C | rock_ID, data = dat_lme, control=(msMaxIter=500)) # adding in random intercept and slope for each rock sample, also increasing the number of iterations to acheive model convergence


m5 <- lme(log(GPP_mgO2_d_m2) ~ temp_C * nutrients + AI + exp_ID, random = ~ 1 + temp_C | rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme, control=(msMaxIter=1000)) # incorporating weights to account for heteroscedasticity within and btwn different experiments, also increasing the number of iterations to acheive model convergence

# changing exp_ID from a fixed effect to a random effect in the models
# this allows the temperature and nutrient intercepts to vary by season

m6 <- lme(log(GPP_mgO2_d_m2) ~ temp_C * nutrients + AI, random = ~ 1 | exp_ID / rock_ID, data = dat_lme)

m7 <- lme(log(GPP_mgO2_d_m2) ~ temp_C * nutrients + AI, random = ~ 1 | exp_ID / rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme)

#m8 <- lme(log(GPP_mgO2_d_m2) ~ temp_C * nutrients + AI, random = ~ 1 + temp_C | exp_ID / rock_ID, data = dat_lme, control=(msMaxIter=500))
# does not converge

m9 <- lme(log(GPP_mgO2_d_m2) ~ temp_C * nutrients + AI, random = ~ 1 + temp_C | exp_ID / rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme, control=(msMaxIter=1000))
# does not converge

AIC(m1, m2, m3, m4, m5, m6, m7, m9)
# model 9 has the lowest AIC

summary(m3)

summary(m6)

summary(m7)

summary(m9)


# interpreting effect sizes of temp from m7
exp(0.028)
# for every 1C increase in temperature, GPP increases by 2.8% (a factor of 1.028 mgO2 per day per m2).
```


#### Graphical model validation
```{r}
# checking ordinary residuals of the final model (these are allowed to show heteroscedasticity). Using code from Zuur et al.
E1 <- resid(m9)
coplot(E1 ∼ rock_ID|exp_ID,
ylab = "Ordinary residuals", data = dat_lme)

# now checking standardized residuals of each of the experiments (random effect in the model). These should not show any patterns and should exhibit homogeneous variance.
E2 <- resid(m9, type = "normalized")
coplot(E2 ∼ rock_ID|exp_ID,
ylab = "Normalized residuals", data = dat_lme)

```


#### emmeans and emmip: Visualizing model interactions
```{r}
emtrends(m9, pairwise ~ nutrients, var = "temp_C")

emmip(m9, nutrients ~ temp_C, cov.reduce = F, CIs = T)
```


## ER
```{r}
# making new dataset for lme models to remove NAs and data from april 2021 experiments
dat_lme <- dat_clean %>%
  filter(!is.na(ER_mgO2_d_m2) & exp_ID > 4)

# converting experiment ID from numberic to a factor
dat_lme$exp_ID <- as.factor(dat_lme$exp_ID)

glimpse(dat_lme)
#View(dat_lme)

# starting with as many explanatory variables as possible in the fixed component of the models (temp, nutrients, and their interaction)
m1 <- gls(log(ER_mgO2_d_m2) ~ temp_C * nutrients + AI + exp_ID, method = "REML", data = dat_lme)

m2 <- lme(log(ER_mgO2_d_m2) ~ temp_C * nutrients + AI + exp_ID, random = ~ 1 | rock_ID, data = dat_lme) # adding in random intercept for each rock sample

m3 <- lme(log(ER_mgO2_d_m2) ~ temp_C * nutrients + AI + exp_ID, random = ~ 1 | rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme)

m4 <- lme(log(ER_mgO2_d_m2) ~ temp_C * nutrients + AI + exp_ID, random = ~ 1 + temp_C | rock_ID, data = dat_lme) # adding random intercept for rock and random slope for temperature


m5 <- lme(log(ER_mgO2_d_m2) ~ temp_C * nutrients + AI + exp_ID, random = ~ 1 + temp_C | rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme)
# does not converge

# adding exp_ID as a random effect instead of a fixed effect

m6 <- lme(log(ER_mgO2_d_m2) ~ temp_C * nutrients + AI, random = ~ 1 | exp_ID / rock_ID, data = dat_lme)

m7 <- lme(log(ER_mgO2_d_m2) ~ temp_C * nutrients + AI, random = ~ 1 | exp_ID / rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme)

m8 <- lme(log(ER_mgO2_d_m2) ~ temp_C * nutrients + AI, random = ~ 1 + temp_C | exp_ID / rock_ID, data = dat_lme)
# does not converge

#m9 <- lme(log(ER_mgO2_d_m2) ~ temp_C * nutrients + AI, random = ~ 1 + temp_C | exp_ID / rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme)
# does not converge


AIC(m1, m2, m3, m4, m5, m6, m7, m8, m9)
# model 9 has the strongest support according to AIC

summary(m9)
# looks like all the fixed effects except AI are statistically significant and will be kept in the model

summary(m7)

# both models 3 and 7 have the structure I need, but including exp_ID (experiment ID) as a random effect is more accurate to the experiment structure since seasonality is nested within the temp:nutrient effects and we expect a distribution of effect estimates across seasons rather than one "true" temp and nutrient effect for all seasons.

ER_final <- m9

```



#### Graphical model validation
```{r}
# checking ordinary residuals of the final model (these are allowed to show heteroscedasticity). Using code from Zuur et al.
E1 <- resid(ER_final)
coplot(E1 ∼ rock_ID|exp_ID,
ylab = "Ordinary residuals", data = dat_lme)

# now checking standardized residuals of each of the experiments (random effect in the model). These should not show any patterns and should exhibit homogeneous variance.
E2 <- resid(ER_final, type = "normalized")
coplot(E2 ∼ rock_ID|exp_ID,
ylab = "Normalized residuals", data = dat_lme)

#coplot(resid(m10) ~ fitted(m10) | dat_lme$exp_ID)
```



#### emmeans and emmip: Visualizing model interactions
```{r}
emtrends(m9, pairwise ~ nutrients, var = "temp_C")

emmip(m9, nutrients ~ temp_C, cov.reduce = F, CIs = T)
```



## NEP
```{r}
# making new dataset for lme models to remove NAs and data from april 2021 experiments
dat_lme <- dat_clean %>%
  filter(!is.na(NEP_mgO2_d_m2) & exp_ID > 4)

# converting experiment ID from numberic to a factor
dat_lme$exp_ID <- as.factor(dat_lme$exp_ID)

glimpse(dat_lme)
#View(dat_lme)

# starting with as many explanatory variables as possible in the fixed component of the models (temp, nutrients, and their interaction)
m1 <- gls(log(NEP_mgO2_d_m2) ~ temp_C * nutrients + AI + exp_ID, method = "REML", data = dat_lme)

m2 <-  lme(log(NEP_mgO2_d_m2) ~ temp_C * nutrients + AI + exp_ID, random = ~ 1 | rock_ID, data = dat_lme) # adding random intercept for each rock

m3 <- lme(log(NEP_mgO2_d_m2) ~ temp_C * nutrients + AI + exp_ID, random = ~ 1 | rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme) # accounting for heteroscedasticity within and among different experiments

m4 <- lme(log(NEP_mgO2_d_m2) ~ temp_C * nutrients + AI + exp_ID, random = ~ 1 + temp_C| rock_ID, data = dat_lme, control=(msMaxIter=500)) # adding random slopes for each rock (i.e. the relationship between temperature and NEP varies for each individual rock)
# model does not converge

m5 <- lme(log(NEP_mgO2_d_m2) ~ temp_C * nutrients + AI + exp_ID, random = ~ 1 + temp_C| rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme, control=(msMaxIter=500)) # now adding in variance structure back in to account for heterscedasticity within and between experiments
# model does not converge

# adding exp_ID as a random effect instead of a fixed effect

m6 <- lme(log(NEP_mgO2_d_m2) ~ temp_C * nutrients + AI, random = ~ 1 | exp_ID / rock_ID, data = dat_lme)

m7 <- lme(log(NEP_mgO2_d_m2) ~ temp_C * nutrients + AI, random = ~ 1 | exp_ID / rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme)

#m8 <- lme(log(NEP_mgO2_d_m2) ~ temp_C * nutrients + AI, random = ~ 1 + temp_C| exp_ID / rock_ID, data = dat_lme, control=(msMaxIter=500))
# does not converge

m9 <- lme(log(NEP_mgO2_d_m2) ~ temp_C * nutrients + AI, random = ~ 1 + temp_C| exp_ID / rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme, control=(msMaxIter=500))

AIC(m1, m2, m3, m4, m5, m6, m7, m9)
# model 9 has the most support according to AIC

summary(m3)

summary(m5)

summary(m7)

summary(m9)
# some big differences between models here, some have insignificant temp effect

NEP_final <- m9

```



#### Graphical model validation
```{r}
# checking ordinary residuals of the final model (these are allowed to show heteroscedasticity). Using code from Zuur et al.
E1 <- resid(NEP_final)
coplot(E1 ∼ rock_ID|exp_ID,
ylab = "Ordinary residuals", data = dat_lme)

# now checking standardized residuals of each of the experiments (random effect in the model). These should not show any patterns and should exhibit homogeneous variance.
E2 <- resid(NEP_final, type = "normalized")
coplot(E2 ∼ rock_ID|exp_ID,
ylab = "Normalized residuals", data = dat_lme)

#coplot(resid(m10) ~ fitted(m10) | dat_lme$exp_ID)
```



#### emmeans and emmip: Visualizing model interactions
```{r}
emtrends(m9, pairwise ~ nutrients, var = "temp_C")

emmip(m9, nutrients ~ temp_C, cov.reduce = F, CIs = T)
```

