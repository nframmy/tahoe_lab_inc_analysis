---
title: "Tahoe City 3/1/21"
author: "Nick Framsted"
date: "3/6/2021"
output: pdf_document
---

```{r setup, include=FALSE}
library(ggplot2)
library(tidyverse)
library(lubridate)
library(ggpubr)
# changing working directory from /scripts to /tahoe_lab_inc_analysis
knitr::opts_knit$set(root.dir = '..')
```


```{r include = FALSE}
# importing and cleaning up data
dat <- read_csv("data/210301_tahoecity_ambient_inc/210302_DO_tahoecity_ambient_R.csv", skip = 1)
str(dat)
#View(dat)

# formatting date times column to posixct
dat$date_time_PST <- dmy_hms(dat$date, tz = "America/Los_Angeles")
head(dat)

# filtering out rows with error codes, and adding in chamber numbers based the tank and channel number cross referenced against incubation notes
dat_2 <- dat %>%
  filter(is.na(error)) %>%
  mutate(chamber = ifelse(tank_channel == "1_1", "Chamber 2", ifelse(tank_channel == "1_2", "Chamber 10", ifelse(tank_channel == "1_3", "Chamber 4", ifelse(tank_channel == "1_4", "Chamber 17", ifelse(tank_channel == "2_1", "Chamber 20", ifelse(tank_channel == "2_2", "Chamber 9", ifelse(tank_channel == "2_3", "Chamber 15", ifelse(tank_channel == "2_4", "Chamber 19", ifelse(tank_channel == "3_1", "Chamber 1", ifelse(tank_channel == "3_2", "Chamber 14", ifelse(tank_channel == "3_3", "Chamber 3", ifelse(tank_channel == "3_4", "Chamber 6", ifelse(tank_channel == "4_1", "Chamber 8", ifelse(tank_channel == "4_2", "Chamber 5", ifelse(tank_channel == "4_3", "Chamber 18", "Chamber 7"))))))))))) ))))) %>%
  mutate(treatment = ifelse(temp > 6 & temp < 9, "7C", ifelse(temp > 8 & temp < 12, "10C", ifelse(temp > 12 & temp < 15, "13C", "16C"))))

head(dat_2)

# double checking this worked
#View(dat_2)


# selecting only columns I need
dat_subset <- dat_2 %>%
  select(date, delta_T_min, oxygen, temp, chamber, date_time_PST, treatment)

# loading in chamber water weight data
dat_chambers <- read_csv("data/210301_tahoecity_ambient_inc/chamber_wts_ambient.csv", skip = 1)

# joining DO dataframe and chamber water weight data
dat_full <- full_join(dat_subset, dat_chambers, by = "chamber")
#View(dat_full)

# calculating oxygen mass balance from DO concentration data
dat_full <- dat_full %>%
  mutate(oxygen_mass_mg = oxygen * water_volume_L)

```

# Plotting DO and temp in chambers
```{r echo = FALSE}
# making treatment a factor variable and re-ordering it for plots
dat_full$treatment <- factor(dat_subset$treatment, levels = c("7C", "10C", "13C", "16C"))

# plotting Do concentration values in each chamber
DO_conc_plot <- dat_full %>%
  ggplot(aes(x = delta_T_min, y = oxygen, color = chamber)) +
  geom_line(size = 1.5) +
  scale_color_viridis_d() +
  facet_wrap(~treatment) +
  labs(y = expression(Oxygen~Concentration~(mg~L^{-1})), x = "Elapsed Time (min)", title = "Tahoe City Incubation DO") +
  theme_bw(base_size = 20) +
  theme(legend.position = "none")

DO_conc_plot

ggsave("plots/210301_tahoecity_ambient/210301_tahoecity_DO_conc_plot.png", plot = DO_conc_plot, width = 10, height = 7)

# plotting temperature for each chamber
temp_plot <- dat_subset %>%
  ggplot(aes(x = delta_T_min, y = temp, color = chamber)) +
  geom_line(size = 1.5) +
  scale_color_viridis_d() +
  facet_wrap(~treatment) +
  labs(y = expression('Temperature (\u00B0C)'), x = "Elapsed Time (min)", title = "Tahoe City Incubation Temperature") +
  theme_bw(base_size = 20) +
  theme(legend.position = "none")

temp_plot

ggsave("plots/210301_tahoecity_ambient/210301_tahoecity_temp_plot.png", plot = temp_plot, width = 10, height = 7)

# plotting DO mass values (mg) for each chamber
DO_mass_plot <- dat_full %>%
  ggplot(aes(x = delta_T_min, y = oxygen_mass_mg, color = chamber)) +
  geom_line(size = 1.5) +
  scale_color_viridis_d() +
  facet_wrap(~treatment) +
  labs(y = expression(Oxygen~Mass~(mg)), x = "Elapsed Time (min)", title = "Tahoe City Incubation DO") +
  theme_bw(base_size = 20) +
  theme(legend.position = "none")

DO_mass_plot

ggsave("plots/210301_tahoecity_ambient/210301_tahoecity_DO_mass_plot.png", plot = DO_mass_plot, width = 10, height = 7)

```

The weird changes in temperature that cause shifts in DO during the respiration period of the incubation are due to artificial changes in temperature measured in the waterbaths, but this does not reflect the temperatures on the inside of the chambers. This is because the oxygen concentrations measured in the chambers are incongruous with the temperature measurements in the waterbaths. The chambers tend to heat/cool at half the rate as the waterbaths, so temperatures are much more stable in them compared to the outside water bath. This fact led to errors in our oxygen measurements.

Possible remedies:
1) Drill holes in 4 unused chambers (1 for each tank), fill with water at same temperature as tahoe water, and place temp sensor from presens instrument in each one. This method worked in the subsequent tahoe city enriched incubation.

2) Place a Hobo logger in 4 unused chambers and post-process DO data from instrument using Hobo temperature data. This involves intercalibrating all temp sensors and adjusting DO data using the Hobo temp Data.

3) Splice together segements of respiration signals and remove areas of weird data caused by spurious temperature measurements.