---
title: "210301-210315 Tahoe City Inc"
author: "Nick Framsted"
date: "7/6/2021"
output: pdf_document
---

```{r setup, include=FALSE}
library(ggplot2)
library(tidyverse)
library(lubridate)
library(ggpubr)
library(plotly)
library(reshape2)
library(DescTools)

# changing working directory from /scripts to /tahoe_lab_inc_analysis
knitr::opts_knit$set(root.dir = '..')
```

# Importing and Processing data
```{r, include = FALSE}
# importing and cleaning up metabolism data from both ambient and enriched incubations
dat_a <- read_csv("data/210301_tahoecity_ambient_inc/210301_TC_ambient_rates.csv")
# changing class of chamber column to be compatible with the other dataframe
dat_a$chamber <- as.character(dat_a$chamber)

# selecting only the columns that I need
dat_a <- dat_a %>%
  select(chamber, temp_C, total_DW_g, total_AFDW_g, rock_SA_m2, NEP_mg_d:nutrient_trt)

dat_e <- read_csv("data/210315_tahoecity_enriched_inc/210315_TC_enriched_rates.csv")

# selecting only the columns that I need
dat_e <- dat_e %>%
  select(chamber, total_DW_g, total_AFDW_g, rock_SA_m2, NEP_mg_d:nutrient_trt)

# binding the rows of the two dataframes together
dat <- bind_rows(dat_a, dat_e)
# adding in nutrient enriched dummy variable column (0 = ambient, 1 = enriched nutrients)
dat <- dat %>%
  mutate(nutrients = ifelse(nutrient_trt == "ambient", 0, 1))
#View(dat)

```

# Regression of AFDW-normalized GPP with temperature and nutrients
```{r}
# linear model of GPP and temp
GPP_AFDW_mod <- lm(GPP_mgO2_d_gAFDW ~ temp_C*nutrients, dat)
summary(GPP_AFDW_mod)

dat %>%
  ggplot(aes(x = temp_C, y = GPP_mgO2_d_gAFDW, color = nutrient_trt)) +
  geom_point(shape = 19, size = 2) +
  geom_smooth(method = "lm") +
  stat_regline_equation() +
  theme_classic() +
  labs(title = "GPP response to Temperature",
      x = expression('Temperature (\u00B0C)'),
      y = expression(GPP~(mgO[2]~day^{-1}~gAFDW^{-1})))
```


# Regression of surface area-normalized GPP with temperature and nutrients
```{r}
# linear model of GPP and temp
GPP_SA_mod <- lm(GPP_mgO2_d_m2 ~ temp_C*nutrients, dat)
summary(GPP_SA_mod)

GPP_SA_plot <- dat %>%
  ggplot(aes(x = temp_C, y = GPP_mgO2_d_m2, color = nutrient_trt)) +
  geom_point(shape = 19, size = 2) +
  geom_smooth(method = "lm") +
  stat_regline_equation() +
  theme_classic() +
  labs(title = "GPP response to Temperature",
      x = expression('Temperature (\u00B0C)'),
      y = expression(GPP~(mgO[2]~day^{-1}~m^{-2})))
GPP_SA_plot

# making simplified plot w/o expressions for use in plotly function
GPP_SA <- dat %>%
  ggplot(aes(x = temp_C, y = GPP_mgO2_d_m2, color = nutrient_trt, group = chamber)) +
  geom_point(shape = 19, size = 2) +
  geom_smooth(method = "lm") +
  stat_regline_equation() +
  theme_classic()
# interactive plotly plot to get info on individual data points
GPP_SA_plotly <- plotly::ggplotly(GPP_SA)
GPP_SA_plotly
```

# Regression of ER (AFDW-normalized) with temperature and nutrients
```{r}
ER_AFDW_mod <- lm(ER_mgO2_d_gAFDW ~ temp_C*nutrients, dat)
summary(ER_AFDW_mod)

dat %>%
  ggplot(aes(x = temp_C, y = ER_mgO2_d_gAFDW, color = nutrient_trt)) +
  geom_point(shape = 19, size = 2) +
  geom_smooth(method = "lm") +
  stat_regline_equation() +
  theme_classic() +
  labs(title = "ER response to Temperature",
      x = expression('Temperature (\u00B0C)'),
      y = expression(ER~(mgO[2]~day^{-1}~gAFDW^{-1})))
```

# Regression of surface area-normalized ER with temp and nutrients
```{r}
# linear model of GPP and temp
ER_SA_mod <- lm(ER_mgO2_d_m2 ~ temp_C*nutrients, dat)
summary(ER_SA_mod)

dat %>%
  ggplot(aes(x = temp_C, y = ER_mgO2_d_m2, color = nutrient_trt)) +
  geom_point(shape = 19, size = 2) +
  geom_smooth(method = "lm") +
  stat_regline_equation() +
  theme_classic() +
  labs(title = "ER response to Temperature",
      x = expression('Temperature (\u00B0C)'),
      y = expression(ER~(mgO[2]~day^{-1}~m^{-2})))

# making simplified plot without expressions in the axis labels for plotly
ER_SA_plot <- dat %>%
  ggplot(aes(x = temp_C, y = ER_mgO2_d_m2, color = nutrient_trt, group = chamber)) +
  geom_point(shape = 19, size = 2) +
  geom_smooth(method = "lm") +
  stat_regline_equation() +
  theme_classic()

# ploting interactive plot in plotly to identify which datapoints correspond to which chambers
ER_SA_plotly <- plotly::ggplotly(ER_SA_plot)
ER_SA_plotly

```


# Regression of surface area-normalized NEP with temp and nutrients
```{r}
# linear model of GPP and temp
NEP_SA_mod <- lm(NEP_mgO2_d_m2 ~ temp_C*nutrients, dat)
summary(NEP_SA_mod)

dat %>%
  ggplot(aes(x = temp_C, y = NEP_mgO2_d_m2, color = nutrient_trt)) +
  geom_point(shape = 19, size = 2) +
  geom_smooth(method = "lm") +
  stat_regline_equation() +
  theme_classic() +
  labs(title = "NEP response to Temperature",
      x = expression('Temperature (\u00B0C)'),
      y = expression(NEP~(mgO[2]~day^{-1}~m^{-2})))

# making simplified plot without expressions in the axis labels for plotly
NEP_SA_plot <- dat %>%
  ggplot(aes(x = temp_C, y = NEP_mgO2_d_m2, color = nutrient_trt, group = chamber)) +
  geom_point(shape = 19, size = 2) +
  geom_smooth(method = "lm") +
  stat_regline_equation() +
  theme_classic()

# ploting interactive plot in plotly to identify which datapoints correspond to which chambers
NEP_SA_plotly <- plotly::ggplotly(NEP_SA_plot)
NEP_SA_plotly
```
Still seeing some outliers for chambers 2, 8, and 13. These chambers have large NEP rates and low ER rates when normalized to rock surface area. To test if this is due to possible errors in surface area measurments or is actually the result of abnormal DO curves I will plot non-normalized metabolic rates.

# Investigating outlying datapoints and sources of error
```{r}
# Plotting non normalized NEP + ER to investigate sources of variation. This could either be error in DO measurements or error in surface area measurments.

## NEP ##
# making simplified plot without expressions in the axis labels for plotly
NEP_plot <- dat %>%
  ggplot(aes(x = temp_C, y = NEP_mg_d, color = nutrient_trt, group = chamber)) +
  geom_point(shape = 19, size = 2) +
  geom_smooth(method = "lm") +
  stat_regline_equation() +
  theme_classic()

# ploting interactive plot in plotly to identify which datapoints correspond to which chambers
NEP_plotly <- plotly::ggplotly(NEP_plot)
NEP_plotly

## ER ##
# making simplified plot without expressions in the axis labels for plotly
ER_plot <- dat %>%
  ggplot(aes(x = temp_C, y = ER_mg_d, color = nutrient_trt, group = chamber)) +
  geom_point(shape = 19, size = 2) +
  geom_smooth(method = "lm") +
  stat_regline_equation() +
  theme_classic()

# ploting interactive plot in plotly to identify which datapoints correspond to which chambers
ER_plotly <- plotly::ggplotly(ER_plot)
ER_plotly
```
Rocks 2, 8, and 13 have outlying data points. They appear to have near-normal metabolic rates before being normalized to rock surface area. Additionally, these 3 outlying rocks each tend to be on the smaller end with rocks 2 and 8 being the smallest 2 rocks and rock 13 being the 4th smallest rock. This suggests the source of error for these outlying data points is in the surface area measurements rather than the DO measurements. For this reason they should possibly be excluded from the regression analyses.
