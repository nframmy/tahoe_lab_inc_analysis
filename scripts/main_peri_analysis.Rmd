---
title: "Main Periphyton Analysis"
author: "Nick Framsted"
date: "7/29/2021"
output: pdf_document
---
Analysis of all Tahoe Periphyton Metabolism Data

Input data files: Individual dataframes generated from separate analyses of each incubation.

Output data files: Main dataframe of combined dataframes from each incubation.

```{r setup, include=FALSE}
library(ggplot2)
library(tidyverse)
library(lubridate)
library(ggpubr)
library(plotly)
library(reshape2)
library(DescTools)
library(arm)
library(nlme)
library(lattice)

# changing working directory from /scripts to /tahoe_lab_inc_analysis
knitr::opts_knit$set(root.dir = '..')
```

# Loading and formatting dataframe
```{r, include = FALSE}
# importing, cleaning up, and combining metabolism data from all incubations
### 210301-210315 TC Ambient & Enriched data
dat1 <- read_csv("data/main_analysis/210301_210315_TC_A_E_rates.csv")


### 210407-210421 Pineland A & E data
dat2 <- read_csv("data/main_analysis/210407_210421_pnld_A_E_rates.csv")


### 210613 Pineland A & E data

dat3 <- read_csv("data/main_analysis/210613_pnld_A_E_rates.csv")

### 210808 Pineland A & E data

dat4 <- read_csv("data/main_analysis/210808_pnld_A_E_rates.csv")


### 211010 Pineland A & E data

dat5 <- read_csv("data/main_analysis/211010_pnld_A_E_rates.csv")



########## Data Formatting #############

dat1 <- dat1 %>%
  mutate(season = "spring", month = "march") # adding season and month columns to dataframe



dat2 <- dat2 %>%
  mutate(season = "spring", month = "april")


dat3 <- dat3 %>%
  mutate(season = "summer", month = "june")


dat4 <- dat4 %>%
  mutate(season = "summer", month = "august")

dat5 <- dat5 %>%
  mutate(season = "fall", month = "october")

######### Combining dataframes #########
dat <- bind_rows(dat1, dat2, dat3, dat4, dat5)
head(dat)

# adding in raw nutrient concentrations of ambient and enriched water for each experiment
dat <- dat %>%
  mutate(NO3_N_ug_L = case_when(
    nutrient_trt == "ambient" & month == "march" ~ 1.41,
    nutrient_trt == "enriched" & month == "march" ~ 534.89,
    nutrient_trt == "ambient" & month == "april" ~ 7.03,
    nutrient_trt == "enriched" & month == "april" ~ 45.19,
    nutrient_trt == "ambient" & month == "june" ~ 11.01,
    nutrient_trt == "enriched" & month == "june" ~ 374.8,
    nutrient_trt == "ambient" & month == "august" ~ 7.5,
    nutrient_trt == "enriched" & month == "august" ~ 387.33,
    nutrient_trt == "ambient" & month == "october" ~ 4.53,
    nutrient_trt == "enriched" & month == "october" ~ 376.76
  ),
  NH4_N_ug_L = case_when(
    nutrient_trt == "ambient" & month == "march" ~ 0.39,
    nutrient_trt == "enriched" & month == "march" ~ 571.52,
    nutrient_trt == "ambient" & month == "april" ~ 1.22,
    nutrient_trt == "enriched" & month == "april" ~ 45.31,
    nutrient_trt == "ambient" & month == "june" ~ 0, # if concentrations were negative, I entered them in as 0
    nutrient_trt == "enriched" & month == "june" ~ 395.58,
    nutrient_trt == "ambient" & month == "august" ~ 4.57,
    nutrient_trt == "enriched" & month == "august" ~ 416.04,
    nutrient_trt == "ambient" & month == "october" ~ 5.03,
    nutrient_trt == "enriched" & month == "october" ~ 438.69
  ),
  SRP_ug_L = case_when(
    nutrient_trt == "ambient" & month == "march" ~ 2.77,
    nutrient_trt == "enriched" & month == "march" ~ 823.85,
    nutrient_trt == "ambient" & month == "april" ~ 2.53,
    nutrient_trt == "enriched" & month == "april" ~ 67.91,
    nutrient_trt == "ambient" & month == "june" ~ 3.17,
    nutrient_trt == "enriched" & month == "june" ~ 315.47,
    nutrient_trt == "ambient" & month == "august" ~ 5.43,
    nutrient_trt == "enriched" & month == "august" ~ 320.3,
    nutrient_trt == "ambient" & month == "october" ~ 3.41,
    nutrient_trt == "enriched" & month == "october" ~ 325.74
  ))


####### Adding in Unique Chamber ID for each Experiment #########
dat <- dat %>%
  mutate(exp_ID = case_when(
    nutrients == 0 & month == "march" ~ 1,
    nutrients == 1 & month == "march" ~ 2, # since these were separate experiments on different periphyton samples, they get unique experiment IDs
    nutrients == 0 & month == "april" ~ 3,
    nutrients == 1 & month == "april" ~ 4,
    month == "june" ~ 5, # june, aug, and oct experiments used same rocks and chamber assignments for ambient and enriched runs, so it gets the same experiment ID
    month == "august" ~ 6,
    month == "october" ~ 7
  ))

# Creating rock_ID column
# using chamber and experiment # columns to give a unique code for each individual rock (this will indicate some sort of chamber or rock effect from repeated measures during the ambient and enriched nutrient runs)

dat <- dat %>%
  mutate(rock_ID = case_when(
    exp_ID == 5 & nutrients == 1 ~ row_number() - 16, # accouting for repeated measures on same rocks for the 5,6, and 7th experiments
    exp_ID == 6 & nutrients == 1 ~ row_number() - 16,
    exp_ID == 7 & nutrients == 1 ~ row_number() - 16,
     TRUE ~ as.double(row_number())
    ))
#View(dat)

# making rock_ID column a factor instead of numeric for analysis
dat$rock_ID <- as.factor(dat$rock_ID)

# exporting combined dataframe as .csv
write_csv(dat, "data/main_analysis/main_rate_data.csv")

#View(dat)

# removing data from march experiments since it was at a different site and had excessive variation in AFDW-normalized GPP rates due to a discrepancy in filtering methods
dat_pnld <- dat %>%
  filter(!month == "march")
#View(dat_pnld)
glimpse(dat_pnld)

```


# Plotting main data
## AFDW-normalized metabolic rates
### GPP
```{r}
# linear model of log-transformed GPP (biomass-normalized) and log-transformed temperature

# linear model of GPP (AFDW-normalized)
log_GPP_AFDW_mod <- lm(log(GPP_mgO2_d_gAFDW) ~ log(temp_C)*nutrients*season, dat_pnld)
summary(log_GPP_AFDW_mod)

plot(log_GPP_AFDW_mod)
###### Model interpretations ######

# interpreting effect size of temperature effect
exp(coef(log_GPP_AFDW_mod)["log(temp_C)"])


GPP_log_log <- dat_pnld %>%
  ggplot(aes(x = temp_C, y = GPP_mgO2_d_gAFDW, color = season)) +
  facet_wrap(~nutrient_trt) +
  scale_y_log10() +
  scale_x_log10() +
  geom_point(shape = 19, size = 2) +
  geom_smooth(method = "lm") +
  #scale_color_discrete(name = "Nutrient Treatment")+
  theme_classic() +
  labs(title = "Periphyton GPP vs. Temperature",
      x = expression('Temperature (\u00B0C)'),
      y = expression(GPP~(mgO[2]~day^{-1}~gAFDW^{-1})))

GPP_log_log


# investigating outlier datapoints using plotly to identify datapoints
GPP_plotly <- dat_pnld %>%
  ggplot(aes(x = temp_C, y = GPP_mgO2_d_gAFDW, color = season)) +
  facet_wrap(~nutrient_trt) +
  scale_y_log10() +
  scale_x_log10() +
  geom_point(aes(group = chamber), shape = 19, size = 2) +
  geom_smooth(method = "lm") +
  #scale_color_discrete(name = "Nutrient Treatment")+
  theme_classic()

p <- plotly::ggplotly(GPP_plotly)
p

# Chambers 1 appears to be outliers for the june ambient incubations, and will be removed in subsequent analyses.

# removing outliers
dat_clean <- dat_pnld[-c(33,35),]
View(dat_clean)

# linear model of GPP (AFDW-normalized)
log_GPP_AFDW_mod <- lm(log(GPP_mgO2_d_gAFDW) ~ log(temp_C)*nutrients*season, dat_clean)
summary(log_GPP_AFDW_mod)

plot(log_GPP_AFDW_mod)
###### Model interpretations ######

# interpreting effect size of temperature effect
exp(coef(log_GPP_AFDW_mod)["log(temp_C)"])


GPP_log_log <- dat_clean %>%
  ggplot(aes(x = temp_C, y = GPP_mgO2_d_gAFDW, group = interaction(season, nutrients))) +
  scale_y_log10() +
  scale_x_log10() +
  geom_point(aes(shape = season, color = nutrient_trt), size = 1.5) +
  scale_shape_manual(values = c(17, 19, 15)) +
  geom_smooth(aes(color = nutrient_trt), method = "lm") +
  #scale_color_discrete(name = "Nutrient Treatment")+
  theme_classic() +
  labs(title = "Periphyton GPP vs. Temperature",
      x = expression('Temperature (\u00B0C)'),
      y = expression(GPP~(mgO[2]~day^{-1}~gAFDW^{-1})))

GPP_log_log

ggsave("plots/main_analysis/GPP_log_log_main.png", plot = GPP_log_log, width = 4, height = 2.5)
```


### ER
```{r}
# linear model of ER (AFDW-normalized)
log_ER_AFDW_mod <- lm(log(ER_mgO2_d_gAFDW) ~ log(temp_C)*nutrients*season, dat_clean)
summary(log_ER_AFDW_mod)

plot(log_ER_AFDW_mod)

###### Model interpretations ######

# interpreting effect size of temperature effect
exp(coef(log_ER_AFDW_mod)["log(temp_C)"])


ER_log_log <- dat_clean %>%
  ggplot(aes(x = temp_C, y = ER_mgO2_d_gAFDW, group = interaction(season, nutrients))) +
  scale_y_log10() +
  scale_x_log10() +
  geom_point(aes(shape = season, color = nutrient_trt), size = 1.5) +
  scale_shape_manual(values = c(17, 19, 15)) +
  geom_smooth(aes(color = nutrient_trt), method = "lm") +
  #scale_color_discrete(name = "Nutrient Treatment")+
  theme_classic() +
  labs(title = "Periphyton ER vs. Temperature",
      x = expression('Temperature (\u00B0C)'),
      y = expression(ER~(mgO[2]~day^{-1}~gAFDW^{-1})))

ER_log_log

ggsave("plots/main_analysis/ER_log_log_main.png", plot = ER_log_log, width = 4, height = 2.5)
```

### NEP
```{r}
# linear model of NEP (AFDW-normalized)
log_NEP_AFDW_mod <- lm(log(NEP_mgO2_d_gAFDW) ~ log(temp_C)*nutrients*season, dat_clean)
summary(log_NEP_AFDW_mod)

# plotting residuals by season
#boxplot(resid(log_NEP_AFDW_mod) ~ dat_clean)

plot(log_NEP_AFDW_mod)
###### Model interpretations ######

# interpreting effect size of temperature effect
exp(coef(log_NEP_AFDW_mod)["log(temp_C)"])


NEP_log_log <- dat_clean %>%
  ggplot(aes(x = temp_C, y = NEP_mgO2_d_gAFDW, group = interaction(season, nutrients))) +
  scale_y_log10() +
  scale_x_log10() +
 geom_point(aes(shape = season, color = nutrient_trt), size = 1.5) +
  scale_shape_manual(values = c(17, 19, 15)) +
  geom_smooth(aes(color = nutrient_trt), method = "lm") +
  #scale_color_discrete(name = "Nutrient Treatment")+
  theme_classic() +
  labs(title = "Periphyton NEP vs. Temperature",
      x = expression('Temperature (\u00B0C)'),
      y = expression(NEP~(mgO[2]~day^{-1}~gAFDW^{-1})))

NEP_log_log

ggsave("plots/main_analysis/NEP_log_log_main.png", plot = NEP_log_log, width = 4, height = 2.5)
```

These linear models with no random effects may be overstating their confidence in the significance of the predictors since pooling the variance between seasons might be masking some of the season-level correlation (or covariance) between predictors like temperature.

# Faceting the above plots
```{r}
# melting dataframe to long format so that metabolic rate columns are combined into one column and values are in a separate column so all can be plotted at once
dat_long <- dat_clean %>%
  rename(GPP = GPP_mgO2_d_gAFDW, ER = ER_mgO2_d_gAFDW, NEP = NEP_mgO2_d_gAFDW) %>% # renaming columns so that facet labels are more tidy
  pivot_longer(cols = c(NEP, GPP, ER),
               names_to = "rate_name_AFDW",
               values_to = "rates_AFDW",
               values_drop_na = TRUE)
#View(dat_long)

# plotting same as above plots, but facetting by rate_name so that the temperature axis is shared between plots

rates_log_log <- dat_long %>%
  ggplot(aes(x = temp_C, y = rates_AFDW, group = interaction(season, nutrients))) +
  facet_grid(cols = vars(rate_name_AFDW)) +
  scale_y_log10() +
  scale_x_log10() +
 geom_point(aes(shape = season, color = nutrient_trt), size = 1.5) +
  scale_shape_manual(values = c(17, 19, 15)) +
  geom_smooth(aes(color = nutrient_trt), method = "lm") +
  scale_color_viridis_d("Nutrient Treatment") + # renaming label of color legend
  scale_shape_discrete(name = "Season") +# renaming label of point shape legend
  theme_minimal() +
  theme(legend.position = "bottom") +
  labs(title = "Periphyton Metabolic Rates vs. Temperature",
      x = expression('Temperature (\u00B0C)'),
      y = expression(Rates~(mgO[2]~day^{-1}~gAFDW^{-1})))

rates_log_log

ggsave("plots/main_analysis/rates_log_log_main.png", plot = rates_log_log, width = 7, height = 3)


# simplified plot for AGU 2021 poster
# making experiment ID column a factor instead of numeric since it is treated as discrete rather than continuous in the plot
dat_long$exp_ID <- as.factor(dat_long$exp_ID)

# now replotting the above plot with the title removed and exp_ID replacing season as a random effect in the model
rates_log_log_AGU <- dat_long %>%
  ggplot(aes(x = temp_C, y = rates_AFDW, group = interaction(exp_ID, nutrients))) +
  facet_grid(cols = vars(rate_name_AFDW)) +
  scale_y_log10() +
  scale_x_log10() +
 geom_point(aes(shape = exp_ID, color = nutrient_trt), size = 1.5) +
  scale_shape_manual(values = c(17, 19, 15)) +
  geom_smooth(aes(color = nutrient_trt), method = "lm") +
  scale_color_viridis_d("Nutrient Treatment") + # renaming label of color legend
  scale_shape_discrete(name = "Experiment ID") +# renaming label of point shape legend
  theme_minimal() +
  theme(legend.position = "bottom") +
  labs(x = expression('Temperature (\u00B0C)'),
      y = expression(Rates~(mgO[2]~day^{-1}~gAFDW^{-1})))

rates_log_log_AGU

ggsave("plots/main_analysis/rates_log_log_AGU.png", plot = rates_log_log_AGU, width = 7, height = 3)

# high quality dpi plot
ggsave("plots/main_analysis/rates_log_log_AGU_hr.png", plot = rates_log_log_AGU, width = 7, height = 3, dpi = 300)
```

# Plotting Areal Rates
```{r}
# melting dataframe to long format so that metabolic rate columns are combined into one column and values are in a separate column so all can be plotted at once
dat_long_m2 <- dat_clean %>%
  rename(GPP = GPP_mgO2_d_m2, ER = ER_mgO2_d_m2, NEP = NEP_mgO2_d_m2) %>% # renaming columns so that facet labels are more tidy
  pivot_longer(cols = c(NEP, GPP, ER),
               names_to = "rate_name_m2",
               values_to = "rates_m2",
               values_drop_na = TRUE)
#View(dat_long_m2)

# plotting same as above plots, but facetting by rate_name so that the temperature axis is shared between plots

areal_rates_log_log <- dat_long_m2 %>%
  ggplot(aes(x = temp_C, y = rates_m2, group = interaction(season, nutrients))) +
  facet_grid(cols = vars(rate_name_m2)) +
  scale_y_log10() +
  scale_x_log10() +
 geom_point(aes(shape = season, color = nutrient_trt), size = 1.5) +
  scale_shape_manual(values = c(17, 19, 15)) +
  geom_smooth(aes(color = nutrient_trt), method = "lm") +
  scale_color_viridis_d("Nutrient Treatment") + # renaming label of color legend
  scale_shape_discrete(name = "Season") +# renaming label of point shape legend
  theme_minimal() +
  theme(legend.position = "bottom") +
  labs(title = "Periphyton Areal Metabolic Rates vs. Temperature",
      x = expression('Temperature (\u00B0C)'),
      y = expression(Rates~(mgO[2]~day^{-1}~m^{-2})))

areal_rates_log_log

ggsave("plots/main_analysis/areal_rates_log_log_main.png", plot = areal_rates_log_log, width = 7, height = 3)


# simplified plot for AGU 2021 poster

# making experiment ID column a factor instead of numeric since it is treated as discrete rather than continuous in the plot
dat_long_m2$exp_ID <- as.factor(dat_long_m2$exp_ID)

# now replotting the above plot with the title removed and exp_ID replacing season as a random effect in the model
areal_rates_log_log_AGU <- dat_long_m2 %>%
  ggplot(aes(x = temp_C, y = rates_m2, group = interaction(exp_ID, nutrients))) +
  facet_grid(cols = vars(rate_name_m2)) +
  scale_y_log10() +
  scale_x_log10() +
 geom_point(aes(shape = exp_ID, color = nutrient_trt), size = 1.5) +
  scale_shape_manual(values = c(17, 19, 15)) +
  geom_smooth(aes(color = nutrient_trt), method = "lm") +
  scale_color_viridis_d("Nutrient Treatment") + # renaming label of color legend
  scale_shape_discrete(name = "Experiment ID") +# renaming label of point shape legend
  theme_minimal() +
  theme(legend.position = "bottom") +
  labs(x = expression('Temperature (\u00B0C)'),
      y = expression(Rates~(mgO[2]~day^{-1}~m^{-2})))

areal_rates_log_log_AGU

ggsave("plots/main_analysis/areal_rates_log_log_AGU.png", plot = areal_rates_log_log_AGU, width = 7, height = 3, dpi = 300)
```

# Exploratory Data Analysis
```{r}
# histogram of temperature data to check normality
dat_pnld %>%
  ggplot(aes(temp_C)) +
  geom_histogram()
# looks approximately like a normal distribution

# now checking normality in AFDW-normalized metabolic rates
dat_pnld %>%
  ggplot(aes(GPP_mgO2_d_gAFDW)) +
  geom_histogram()

dat_pnld %>%
  ggplot(aes(NEP_mgO2_d_gAFDW)) +
  geom_histogram()

dat_pnld %>%
  ggplot(aes(ER_mgO2_d_gAFDW)) +
  geom_histogram()
# some definite outliers present, also some potential for a right-skewed distn in the ER and GPP rates.

# cleveland plot
# dotchart(dat_pnld$)

# selecting only the numeric columns for calculating a correlation matrix
dat_cor <- dat_pnld %>%
  dplyr::select(temp_C, GPP_mgO2_d_gAFDW, NEP_mgO2_d_gAFDW, ER_mgO2_d_gAFDW, GPP_mgO2_d_m2, NEP_mgO2_d_m2, ER_mgO2_d_m2, NO3_N_ug_L, NH4_N_ug_L, SRP_ug_L)

# standardizing data with mean = 0, sd = 1 for correlation matrix
dat_cor <- scale(dat_cor)
View(dat_cor)

# plotting correlation matrix of the data
cor(dat_cor, use = "complete.obs")

```



# Random Effects Modeling
## GPP
```{r}
# nested random effects model with temp and nutrients as predictors, and season as a random effect (with differing intercept and slope for each season)

# this basically is saying that the effect of increasing temperature varies among seasons, and that each season has different GPP values
m6 <- lmer(log(GPP_mgO2_d_gAFDW) ~ log(temp_C)*nutrients + (1 + log(temp_C)|season), data = dat_clean)
display(m6)
summary (m6)


# random effects model with random intercept for season only

m5 <- lmer(log(GPP_mgO2_d_gAFDW) ~ log(temp_C)*nutrients + (1|season), data = dat_clean)
display(m5)
summary(m5)

m7 <- lmer(log(GPP_mgO2_d_gAFDW) ~ log(temp_C)*nutrients + (1 + nutrients|season), data = dat_clean)

m8 <- lmer(log(GPP_mgO2_d_gAFDW) ~ log(temp_C)*nutrients + (1 + nutrients|season) + (1 + log(temp_C)|season), data = dat_clean)

m3 <- lm(log(GPP_mgO2_d_gAFDW) ~ log(temp_C)*nutrients, data = dat_clean)

m1 <- lm(log(GPP_mgO2_d_gAFDW) ~ log(temp_C), data = dat_clean)

m2 <- lm(log(GPP_mgO2_d_gAFDW) ~ nutrients, data = dat_clean)

m4 <- lm(log(GPP_mgO2_d_gAFDW) ~ log(temp_C)*nutrients*season, data = dat_clean)
summary(m8)

summary(m4)


AIC(m1, m2, m3, m4, m5, m6, m7, m8)
BIC(m1, m2, m3, m4, m5, m6, m7, m8)

```

Looks like model 8 has the lowest AIC and is the most parsimonious model with temperature, nutrients, season, and their interaction as predictors.

What does this model look like plotted out?

How to interpret significant 3-way interaction btwn temp, nuts, and season?

Does the interaction between temp and season even meaningful since we already know temp covaries with season?

## ER
```{r}
# nested random effects model with temp and nutrients as predictors, and season as a random effect (with differing intercept and slope for each season)

# this basically is saying that the effect of increasing temperature varies among seasons, and that each season has different ER values
m6 <- lmer(log(ER_mgO2_d_gAFDW) ~ log(temp_C)*nutrients + (1 + log(temp_C)|season), data = dat_clean)
display(m6)
summary (m6)


# random effects model with random intercept for season only

m5 <- lmer(log(ER_mgO2_d_gAFDW) ~ log(temp_C)*nutrients + (1|season), data = dat_clean)
display(m5)
summary(m5)

m7 <- lmer(log(ER_mgO2_d_gAFDW) ~ log(temp_C)*nutrients + (1 + nutrients|season), data = dat_clean)

m8 <- lmer(log(ER_mgO2_d_gAFDW) ~ log(temp_C)*nutrients + (1 + nutrients|season) + (1 + log(temp_C)|season), data = dat_clean)

m3 <- lm(log(ER_mgO2_d_gAFDW) ~ log(temp_C)*nutrients, data = dat_clean)

m1 <- lm(log(ER_mgO2_d_gAFDW) ~ log(temp_C), data = dat_clean)

m2 <- lm(log(ER_mgO2_d_gAFDW) ~ nutrients, data = dat_clean)

m4 <- lm(log(ER_mgO2_d_gAFDW) ~ log(temp_C)*nutrients*season, data = dat_clean)
summary(m4)

# Best AIC-supported model
summary(m4)

AIC(m1, m2, m3, m4, m5, m6, m7, m8)
BIC(m1, m2, m3, m4, m5, m6, m7, m8)
```

# Random Effects W/o season
## GPP
```{r}
m1 <- lm(log(GPP_mgO2_d_gAFDW) ~ log(temp_C), data = dat_clean)

m2 <- lm(log(GPP_mgO2_d_gAFDW) ~ nutrients, data = dat_clean)

m3 <- lmer(log(GPP_mgO2_d_gAFDW) ~ log(temp_C) + (1|rock_ID), data = dat_clean)

m4 <- lmer(log(GPP_mgO2_d_gAFDW) ~ nutrients + (1|rock_ID), data = dat_clean)

m5 <- lmer(log(GPP_mgO2_d_gAFDW) ~ log(temp_C)*nutrients + (1|rock_ID), data = dat_clean)
display(m5)
summary (m5)

AIC(m1, m2, m3, m4, m5)
BIC(m1, m2, m3, m4, m5)
```

## ER
```{r}
m1 <- lm(log(ER_mgO2_d_gAFDW) ~ log(temp_C), data = dat_clean)

m2 <- lm(log(ER_mgO2_d_gAFDW) ~ nutrients, data = dat_clean)

m3 <- lmer(log(ER_mgO2_d_gAFDW) ~ log(temp_C) + (1|rock_ID), data = dat_clean)

m4 <- lmer(log(ER_mgO2_d_gAFDW) ~ nutrients + (1|rock_ID), data = dat_clean)

m5 <- lmer(log(ER_mgO2_d_gAFDW) ~ log(temp_C)*nutrients + (1|rock_ID), data = dat_clean)
display(m5)
summary (m5)

AIC(m1, m2, m3, m4, m5)
BIC(m1, m2, m3, m4, m5)
```

## NEP
```{r}
m1 <- lm(log(NEP_mgO2_d_gAFDW) ~ log(temp_C), data = dat_clean)

m2 <- lm(log(NEP_mgO2_d_gAFDW) ~ nutrients, data = dat_clean)

m3 <- lmer(log(NEP_mgO2_d_gAFDW) ~ log(temp_C) + (1|rock_ID), data = dat_clean)

m4 <- lmer(log(NEP_mgO2_d_gAFDW) ~ nutrients + (1|rock_ID), data = dat_clean)

m5 <- lmer(log(NEP_mgO2_d_gAFDW) ~ log(temp_C)*nutrients + (1|rock_ID), data = dat_clean)
display(m5)
summary (m5)

AIC(m1, m2, m3, m4, m5)
BIC(m1, m2, m3, m4, m5)
```

# nlme models
## GPP
```{r}
# making new dataset for lme models to remove NAs
dat_lme <- dat_clean %>%
  filter(!is.na(GPP_mgO2_d_gAFDW))

# converting experiment ID from numberic to a factor
dat_lme$exp_ID <- as.factor(dat_lme$exp_ID)

glimpse(dat_lme)
#View(dat_lme)

m1 <- lm(log(GPP_mgO2_d_gAFDW) ~ log(temp_C), data = dat_lme)

m2 <- lm(log(GPP_mgO2_d_gAFDW) ~ nutrients, data = dat_lme)

m3 <- lme(log(GPP_mgO2_d_gAFDW) ~ log(temp_C), random = ~ 1 | rock_ID, data = dat_lme)

m4 <- lme(log(GPP_mgO2_d_gAFDW) ~ nutrients, random = ~ 1 | rock_ID, data = dat_lme)

m5 <- lme(log(GPP_mgO2_d_gAFDW) ~ log(temp_C) * nutrients, random = ~ 1 | rock_ID, data = dat_lme)

#m6 <- lme(log(GPP_mgO2_d_gAFDW) ~ log(temp_C) * nutrients, random = ~ 1 + log(temp_C) | rock_ID, data = dat_lme)
# error message for this model saying it never converged

m7 <- lme(log(GPP_mgO2_d_gAFDW) ~ log(temp_C) * nutrients, random = ~ 1 + nutrients | rock_ID, data = dat_lme)

#m8 <- lme(log(GPP_mgO2_d_gAFDW) ~ log(temp_C) * nutrients, random = list(~ 1 + nutrients | rock_ID, ~ 1 + log(temp_C) | rock_ID), data = dat_lme)
# error message for this model saying it did not converge

# incorporating weights to account for heteroscedasticity within and btwn different experiments
m9 <- lme(log(GPP_mgO2_d_gAFDW) ~ log(temp_C), random = ~ 1 | rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme)

# random intercept model for rock effect
m10 <- lme(log(GPP_mgO2_d_gAFDW) ~ log(temp_C) * nutrients, random = ~ 1 | rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme)

#m11 <- lme(log(GPP_mgO2_d_gAFDW) ~ log(temp_C) * nutrients, random = ~ 1 + nutrients | rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme)
# would not converge

#m12 <- lme(log(GPP_mgO2_d_gAFDW) ~ log(temp_C) * nutrients, random = list(~ 1 | rock_ID, ~ 1 + temp_C | exp_ID), weights = varIdent(form = ~1|exp_ID), data = dat_lme)
# does not converge

#m13 <- lme(log(GPP_mgO2_d_gAFDW) ~ log(temp_C) * nutrients, random = list(~ 1 | rock_ID, ~ 1 + nutrients | exp_ID), weights = varIdent(form = ~1|exp_ID), data = dat_lme)
# does not converge

#m14 <- lme(log(GPP_mgO2_d_gAFDW) ~ log(temp_C) * nutrients, random = list(~ 1 | rock_ID, ~ 1 + temp_C | exp_ID, ~ 1 + nutrients | exp_ID), weights = varIdent(form = ~1|exp_ID), data = dat_lme)
# does not converge

m15 <- lme(log(GPP_mgO2_d_gAFDW) ~ log(temp_C), random = ~ 1 | rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme)

# letting the model variance parameter vary by nutrient treatment and letting this vary between experiment ID. Needed to use VarComb so that I could use the VarExp option since the nutrient treatment contains values of "0" and I needed to combine this with letting sigma_sq vary across different experiments.
m16 <- lme(log(GPP_mgO2_d_gAFDW) ~ log(temp_C) * nutrients, random = ~ 1 | rock_ID, weights = varComb(varIdent(form = ~1|exp_ID), varExp(form = ~ nutrients)), data = dat_lme)

m17 <- lme(log(GPP_mgO2_d_gAFDW) ~ log(temp_C), random = ~ 1 | rock_ID, weights = varIdent(form = ~log(temp_C)|exp_ID), data = dat_lme)
# iteration limit reached without convergence

m18 <- lme(log(GPP_mgO2_d_gAFDW) ~ log(temp_C) * nutrients, random = ~ 1 | rock_ID, weights = varIdent(form = ~log(temp_C)|exp_ID), data = dat_lme)
# false convergence

AIC(m1, m2, m3, m4, m5, m7, m9, m10, m15, m16, m17, m18)
BIC(m1, m2, m3, m4, m5, m7, m9, m10, m15, m16, m17, m18)

# looks like m10, the random intercept model for the rock effect, is the best model. Now lets look at which fixed effects are signficant
summary(m10)
# looks like only log(temp_C) is the only signifcant fixed effect, thus we can drop nutrients and their interaction.

mfinal <- lme(log(GPP_mgO2_d_gAFDW) ~ log(temp_C), random = ~ 1 | rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme)

summary(mfinal)


# graphical model validation using standardized residuals vs. fitten values to look for heteroscedasticity
plot(m10)

```

#### Graphical model validation
```{r}
# checking ordinary residuals of the best model according to AIC (these are allowed to show heteroscedasticity). Using code from Zuur et al.
E1 <- resid(m10)
coplot(E1 ∼ rock_ID|exp_ID,
ylab = "Ordinary residuals", data = dat_lme)

# now checking standardized residuals of each of the experiments (random effect in the model). These should not show any patterns and should exhibit homogeneous variance.
E2 <- resid(m10, type = "normalized")
coplot(E2 ∼ rock_ID|exp_ID,
ylab = "Normalized residuals", data = dat_lme)

#coplot(resid(m10) ~ fitted(m10) | dat_lme$exp_ID)
```


## ER
```{r}
# making new dataset for lme models to remove NAs
dat_lme <- dat_clean %>%
  filter(!is.na(ER_mgO2_d_gAFDW))
glimpse(dat_lme)

m1 <- lm(log(ER_mgO2_d_gAFDW) ~ log(temp_C), data = dat_lme)

m2 <- lm(log(ER_mgO2_d_gAFDW) ~ nutrients, data = dat_lme)

m3 <- lme(log(ER_mgO2_d_gAFDW) ~ log(temp_C), random = ~ 1 | rock_ID, data = dat_lme)

m4 <- lme(log(ER_mgO2_d_gAFDW) ~ nutrients, random = ~ 1 | rock_ID, data = dat_lme)

m5 <- lme(log(ER_mgO2_d_gAFDW) ~ log(temp_C) * nutrients, random = ~ 1 | rock_ID, data = dat_lme)

#m6 <- lme(log(ER_mgO2_d_gAFDW) ~ log(temp_C) * nutrients, random = ~ 1 + log(temp_C) | rock_ID, data = dat_lme)
# error message for this model saying it never converged

m7 <- lme(log(ER_mgO2_d_gAFDW) ~ log(temp_C) * nutrients, random = ~ 1 + nutrients | rock_ID, data = dat_lme)

#m8 <- lme(log(ER_mgO2_d_gAFDW) ~ log(temp_C) * nutrients, random = list(~ 1 +  nutrients | rock_ID, ~ 1 + log(temp_C) | rock_ID), data = dat_lme)
# error message for this model saying it did not converge

# incorporating weights to account for heteroscedasticity within and btwn different experiments
m9 <- lme(log(ER_mgO2_d_gAFDW) ~ log(temp_C) * nutrients, random = ~ 1 | rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme)

#m10 <- lme(log(ER_mgO2_d_gAFDW) ~ log(temp_C) * nutrients, random = ~ 1 + nutrients | rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme)
# would not converge


AIC(m1, m2, m3, m4, m5, m7, m9)
BIC(m1, m2, m3, m4, m5, m7, m9)

summary(m5)
```

## NEP
```{r}
# making new dataset for lme models to remove NAs
dat_lme <- dat_clean %>%
  filter(!is.na(NEP_mgO2_d_gAFDW))
glimpse(dat_lme)

m1 <- lm(log(NEP_mgO2_d_gAFDW) ~ log(temp_C), data = dat_lme)

m2 <- lm(log(NEP_mgO2_d_gAFDW) ~ nutrients, data = dat_lme)

m3 <- lme(log(NEP_mgO2_d_gAFDW) ~ log(temp_C), random = ~ 1 | rock_ID, data = dat_lme)

m4 <- lme(log(NEP_mgO2_d_gAFDW) ~ nutrients, random = ~ 1 | rock_ID, data = dat_lme)

m5 <- lme(log(NEP_mgO2_d_gAFDW) ~ log(temp_C) * nutrients, random = ~ 1 | rock_ID, data = dat_lme)

#m6 <- lme(log(NEP_mgO2_d_gAFDW) ~ log(temp_C) * nutrients, random = ~ 1 + log(temp_C) | rock_ID, data = dat_lme)
# error message for this model saying it never converged

m7 <- lme(log(NEP_mgO2_d_gAFDW) ~ log(temp_C) * nutrients, random = ~ 1 + nutrients | rock_ID, data = dat_lme)

m8 <- lme(log(NEP_mgO2_d_gAFDW) ~ log(temp_C) * nutrients, random = list(~1 + nutrients | rock_ID, ~1 + log(temp_C) | rock_ID), data = dat_lme)

# incorporating weights to account for heteroscedasticity within and btwn experiments
#m9 <- 


AIC(m1, m2, m3, m4, m5, m7, m8)
BIC(m1, m2, m3, m4, m5, m7, m8)

m3
```


# Centering Temp and Nutrient Data by experiment
```{r}
# centering temperature variable to "de-seasonalize" it since baseline temperatures change between seasons. This way we get can model the "treatment condition itself" rather than season. - stats consulting dept in UC Davis

# creating a column of average temperatures for each experiment
dat_centered <- dat_clean %>%
  group_by(month) %>%
  summarise(avg_T = mean(temp_C))

# adding avg T column to main dataframe so that we can mutate a new column of centered temps with it
dat_centered <- left_join(dat_clean, dat_centered, by = "month")

head(dat_centered)

# now subtracting average temp for each incubation from the actual temp to center this variable and remove the "seasonal effect" from temp data
dat_centered <- dat_centered %>%
  mutate(temp_centered = temp_C - avg_T)

head(dat_centered)
#View(dat_centered)
```

##### Plotting centered temp data
```{r}
# first plotting up data to see what it looks like

# melting dataframe to long format so that metabolic rate columns are combined into one column and values are in a separate column so all can be plotted at once
dat_long <- dat_centered %>%
  rename(GPP = GPP_mgO2_d_gAFDW, ER = ER_mgO2_d_gAFDW, NEP = NEP_mgO2_d_gAFDW) %>% # renaming columns so that facet labels are more tidy
  pivot_longer(cols = c(NEP, GPP, ER),
               names_to = "rate_name_AFDW",
               values_to = "rates_AFDW",
               values_drop_na = TRUE)
#View(dat_long)
rates_log_log <- dat_long %>%
  ggplot(aes(x = temp_centered, y = rates_AFDW, group = interaction(season, nutrients))) +
  facet_grid(cols = vars(rate_name_AFDW)) +
  scale_y_log10() +
 geom_point(aes(shape = season, color = nutrient_trt), size = 1.5) +
  scale_shape_manual(values = c(17, 19, 15)) +
  geom_smooth(aes(color = nutrient_trt), method = "lm") +
  scale_color_viridis_d("Nutrient Treatment") + # renaming label of color legend
  scale_shape_discrete(name = "Season") +# renaming label of point shape legend
  theme_minimal() +
  theme(legend.position = "bottom") +
  labs(title = "Periphyton Metabolic Rates vs. Temperature",
      x = expression('Temperature (\u00B0C)'),
      y = expression(Rates~(mgO[2]~day^{-1}~gAFDW^{-1})))

rates_log_log

```

##### Modeling rates with centered temp data
```{r}
# making new dataset for lme models to remove NAs
dat_lme <- dat_centered %>%
  filter(!is.na(GPP_mgO2_d_gAFDW))
glimpse(dat_lme)

m1 <- lm(log(GPP_mgO2_d_gAFDW) ~ temp_centered, data = dat_lme)

m2 <- lm(log(GPP_mgO2_d_gAFDW) ~ nutrients, data = dat_lme)

m3 <- lme(log(GPP_mgO2_d_gAFDW) ~ temp_centered, random = ~ 1 | rock_ID, data = dat_lme)

m4 <- lme(log(GPP_mgO2_d_gAFDW) ~ nutrients, random = ~ 1 | rock_ID, data = dat_lme)

m5 <- lme(log(GPP_mgO2_d_gAFDW) ~ temp_centered * nutrients, random = ~ 1 | rock_ID, data = dat_lme)

#m6 <- lme(log(GPP_mgO2_d_gAFDW) ~ temp_centered * nutrients, random = ~ 1 + temp_centered | rock_ID, data = dat_lme)
# error message for this model saying it never converged

m7 <- lme(log(GPP_mgO2_d_gAFDW) ~ temp_centered * nutrients, random = ~ 1 + nutrients | rock_ID, data = dat_lme)

#m8 <- lme(log(GPP_mgO2_d_gAFDW) ~ temp_centered * nutrients, random = list(~ 1 + nutrients | rock_ID, ~ 1 + temp_centered | rock_ID), data = dat_lme)
# error message for this model saying it did not converge

# incorporating weights to account for heteroscedasticity within and btwn different experiments
m9 <- lme(log(GPP_mgO2_d_gAFDW) ~ temp_centered, random = ~ 1 | rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme)

m10 <- lme(log(GPP_mgO2_d_gAFDW) ~ temp_centered * nutrients, random = ~ 1 | rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme)

#m11 <- lme(log(GPP_mgO2_d_gAFDW) ~ temp_centered * nutrients, random = ~ 1 + nutrients | rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme)
# would not converge

#m12 <- lme(log(GPP_mgO2_d_gAFDW) ~ temp_centered * nutrients, random = list(~ 1 | rock_ID, ~ 1 + temp_centered | exp_ID), weights = varIdent(form = ~1|exp_ID), data = dat_lme)
# does not converge

#m13 <- lme(log(GPP_mgO2_d_gAFDW) ~ temp_centered * nutrients, random = list(~ 1 | rock_ID, ~ 1 + nutrients | exp_ID), weights = varIdent(form = ~1|exp_ID), data = dat_lme)
# does not converge

#m14 <- lme(log(GPP_mgO2_d_gAFDW) ~ temp_centered * nutrients, random = list(~ 1 | rock_ID, ~ 1 + temp_centered | exp_ID, ~ 1 + nutrients | exp_ID), weights = varIdent(form = ~1|exp_ID), data = dat_lme)
# does not converge

m15 <- lme(log(GPP_mgO2_d_gAFDW) ~ temp_centered, random = ~ 1 | rock_ID, weights = varIdent(form = ~1|exp_ID), data = dat_lme)

# letting the model variance parameter vary by nutrient treatment and letting this vary between experiment ID. Needed to use VarComb so that I could use the VarExp option since the nutrient treatment contains values of "0" and I needed to combine this with letting sigma_sq vary across different experiments.
m16 <- lme(log(GPP_mgO2_d_gAFDW) ~ temp_centered * nutrients, random = ~ 1 | rock_ID, weights = varComb(varIdent(form = ~1|exp_ID), varExp(form = ~ nutrients)), data = dat_lme)


# letting the model variance parameter vary by temperature treatment and letting this vary between experiment ID
m17 <- lme(log(GPP_mgO2_d_gAFDW) ~ temp_centered, random = ~ 1 | rock_ID, weights = varIdent(form = ~temp_centered|exp_ID), data = dat_lme)


m18 <- lme(log(GPP_mgO2_d_gAFDW) ~ temp_centered * nutrients, random = ~ 1 | rock_ID, weights = varIdent(form = ~temp_centered|exp_ID), data = dat_lme)


AIC(m1, m2, m3, m4, m5, m7, m9, m10, m15, m16, m17, m18)
BIC(m1, m2, m3, m4, m5, m7, m9, m10, m15, m16, m17, m18)

m3
```

